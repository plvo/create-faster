
 ÔûÉÔûøÔûêÔûêÔûêÔû£Ôûî   Claude Code v2.1.29
ÔûØÔû£ÔûêÔûêÔûêÔûêÔûêÔûøÔûÿ  Opus 4.5 ┬À Claude Max
  ÔûÿÔûÿ ÔûØÔûØ    ~/.lab/create-faster

ÔØ» /clear 
  ÔÄ┐ ┬á(no content)

ÔØ»   /executing-plans docs/plans/2026-02-02-unified-addon-architecture.md    
  don't need my validation between phase implement alls tasks in the plan   

ÔùÅ Skill(executing-plans)
  ÔÄ┐ ┬áSuccessfully loaded skill

ÔùÅ I'm using the executing-plans skill to implement this plan.

  Let me read the plan file first.

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ I've now read the entire plan. This is a substantial refactor with 7 phases
  and multiple tasks. Let me create a TodoWrite to track all tasks, then begin
  implementation.

ÔùÅ Let me first read the current types/meta.ts to understand what we're working
  with:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ Now let me write the failing test first as per TDD:

ÔùÅ Write(apps/cli/tests/addon-types.test.ts)
  ÔÄ┐ ┬áWrote 76 lines to apps/cli/tests/addon-types.test.ts
     // ABOUTME: Type tests for unified addon architecture
     // ABOUTME: Ensures MetaAddon types enforce correct destination 
     constraints

     import { describe, test, expect } from 'bun:test';
     import type {
       AddonType,
       AddonDestination,
       AddonSupport,
       MetaAddon,
       StackName,
     ÔÇª +66 lines (ctrl+o to expand)

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && bun test
      tests/addon-types.test.ts 2>&1 | head -30)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      8 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ The tests pass because TypeScript types are erased at runtime. The tests are
  checking values that get assigned - they'll fail when I try to use types that
  don't exist. Let me update the types/meta.ts to add the new unified types:

ÔùÅ Write(apps/cli/src/types/meta.ts)
  ÔÄ┐ ┬áAdded 21 lines, removed 56 lines
       1  // ABOUTME: Type definitions for META configuration            
       2 -// ABOUTME: Defines stacks, modules, orm, database, extras,    
         -and repo structures                                            
       2 +// ABOUTME: Unified addon system with discriminated            
         +destination types                                              
       3                                                                 
       4  export type StackName = 'nextjs' | 'expo' | 'hono' |           
          'tanstack-start';                                              
       5 -export type StacksCompatibility = StackName[] | 'all';         
       6 -export type ModuleName = string;                               
       7 -export type OrmName = 'drizzle' | 'prisma';                    
       8 -export type DatabaseName = 'postgres' | 'mysql';               
       9 -export type ExtraName = 'biome' | 'husky';                     
       5 +export type AddonType = 'module' | 'orm' | 'database' |        
         +'extra';                                                       
       6  export type RepoType = 'single' | 'turborepo';                 
       7 -export type Category = 'orm' | 'database' | 'extras';          
       7                                                                 
       8 +// Discriminated union for destination - package requires name 
       9 +export type AddonDestination =                                 
      10 +  | { target: 'app' }                                          
      11 +  | { target: 'package'; name: string; singlePath?: string }   
      12 +  | { target: 'root' };                                        
      13 +                                                               
      14 +export interface AddonSupport {                                
      15 +  stacks?: StackName[] | 'all';                                
      16 +  addons?: string[];                                           
      17 +}                                                              
      18 +                                                               
      19  export interface PackageJsonConfig {                           
      20    dependencies?: Record<string, string>;                       
      21    devDependencies?: Record<string, string>;                    
     ...
      17    exports?: Record<string, string>;                            
      18  }                                                              
      19                                                                 
      20 -export interface MetaStack {                                   
      21 -  type: 'app' | 'server';                                      
      20 +export interface MetaAddon {                                   
      21 +  type: AddonType;                                             
      22    label: string;                                               
      23    hint?: string;                                               
      24 -  packageJson: PackageJsonConfig;                              
      24 +  support?: AddonSupport;                                      
      25 +  destination?: AddonDestination;                              
      26 +  packageJson?: PackageJsonConfig;                             
      27  }                                                              
      28                                                                 
      29 -export interface MetaModule {                                  
      29 +export interface MetaStack {                                   
      30 +  type: 'app' | 'server';                                      
      31    label: string;                                               
      32    hint?: string;                                               
      33 -  stacks: StacksCompatibility;                                 
      34 -  asPackage?: string;                                          
      35 -  singlePath?: string;                                         
      36 -  requires?: string[];                                         
      33    packageJson: PackageJsonConfig;                              
      34  }                                                              
      35                                                                 
      36 -export interface MetaOrmStack {                                
      37 -  label: string;                                               
      38 -  hint?: string;                                               
      39 -  asPackage: string;                                           
      40 -  singlePath: string;                                          
      41 -  packageJson: PackageJsonConfig;                              
      42 -}                                                              
      43 -                                                               
      44 -export interface MetaDatabaseStack {                           
      45 -  label: string;                                               
      46 -  hint?: string;                                               
      47 -  packageJson?: PackageJsonConfig;                             
      48 -}                                                              
      49 -                                                               
      50 -export interface MetaExtraStack {                              
      51 -  label: string;                                               
      52 -  hint?: string;                                               
      53 -  requires?: string[];                                         
      54 -  packageJson?: PackageJsonConfig;                             
      55 -}                                                              
      56 -                                                               
      36  export interface MetaRepoStack {                               
      37    label: string;                                               
      38    hint?: string;                                               
      39  }                                                              
      40                                                                 
      41 -export interface MetaOrm {                                     
      42 -  asPackage: string;                                           
      43 -  singlePath: string;                                          
      44 -  requires: string[];                                          
      45 -  stacks: Record<OrmName, MetaOrmStack>;                       
      46 -}                                                              
      47 -                                                               
      41  export interface Meta {                                        
      42    stacks: Record<StackName, MetaStack>;                        
      43 -  modules: Record<ModuleName, MetaModule>;                     
      44 -  orm: MetaOrm;                                                
      45 -  database: {                                                  
      46 -    stacks: Record<DatabaseName, MetaDatabaseStack>;           
      47 -  };                                                           
      48 -  extras: {                                                    
      49 -    stacks: Record<ExtraName, MetaExtraStack>;                 
      50 -  };                                                           
      43 +  addons: Record<string, MetaAddon>;                           
      44    repo: {                                                      
      45      stacks: Record<RepoType, MetaRepoStack>;                   
      46    };                                                           
      47  }                                                              
      48 -                                                               
      49 -export function isModuleCompatible(module: MetaModule,         
         -stackName: StackName): boolean {                               
      50 -  if (module.stacks === 'all') return true;                    
      51 -  return module.stacks.includes(stackName);                    
      52 -}                                                              

ÔùÅ Bash(bun test tests/addon-types.test.ts 2>&1)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      8 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ Task 1.1 complete. Let me commit this:

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add apps/cli/src/types/meta.ts
      apps/cli/tests/addon-types.test.ts && git commit -m "refactor(types):
      unified MetaAddonÔÇª)
  ÔÄ┐ [refactor/template-system 0a36cd7] refactor(types): unified MetaAddon i
    nterface with discriminated destinations
     2 files changed, 128 insertions(+), 88 deletions(-)
    ÔÇª +13 lines (ctrl+o to expand)


ÔùÅ Now Task 1.2: Create addon helper functions. First write the failing test:

ÔùÅ Write(apps/cli/tests/addon-utils.test.ts)
  ÔÄ┐ ┬áWrote 66 lines to apps/cli/tests/addon-utils.test.ts
     // ABOUTME: Tests for addon utility functions
     // ABOUTME: Tests grouping, compatibility, and dependency checking

     import { describe, test, expect, beforeEach } from 'bun:test';
     import {
       getAddonsByType,
       isAddonCompatible,
       areAddonDependenciesMet,
       clearAddonGroupsCache,
     } from '../src/lib/addon-utils';
     ÔÇª +56 lines (ctrl+o to expand)

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && bun test
      tests/addon-utils.test.ts 2>&1 | head -20)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

     tests/addon-utils.test.ts:
     ÔÇª +12 lines (ctrl+o to expand)

ÔùÅ Test fails as expected. Now create addon-utils.ts:

ÔùÅ Write(apps/cli/src/lib/addon-utils.ts)
  ÔÄ┐ ┬áWrote 37 lines to apps/cli/src/lib/addon-utils.ts
     // ABOUTME: Helper functions for working with META addons
     // ABOUTME: Grouping, compatibility checking, and dependency 
     validation

     import type { Meta, MetaAddon, AddonType, StackName } from
     '@/types/meta';

     let addonGroupsCache: Record<AddonType, string[]> | null = null;

     export function getAddonsByType(meta: Meta): Record<AddonType, 
     string[]> {
       if (addonGroupsCache) return addonGroupsCache;

     ÔÇª +27 lines (ctrl+o to expand)

ÔùÅ Now the test needs META.addons to exist. The test imports from __meta__ but
  that still has the old structure. I need to move to Task 1.4 to update
  __meta__.ts first, or I can update the test to use a mock META. Let me check
  what the plan says...

  Looking at the plan, Task 1.2's test depends on Task 1.4's META.addons.
  However, the plan says to write tests that will fail initially. Let me run the
   test to see what happens:

ÔùÅ Bash(bun test tests/addon-utils.test.ts 2>&1 | head -30)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

     tests/addon-utils.test.ts:
     ÔÇª +35 lines (ctrl+o to expand)

ÔùÅ As expected, META.addons doesn't exist yet. The tests will pass once we update
   __meta__.ts. Let me continue with the plan approach - I'll note that this
  test will pass after Task 1.4.

  Let me commit the addon-utils.ts file (test will fail until META is updated):

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add
      apps/cli/src/lib/addon-utils.ts apps/cli/tests/addon-utils.test.ts && git
      commit -m "feat(addon-utils): helper funÔÇª)
  ÔÄ┐ ┬á[refactor/template-system 0a1965a] feat(addon-utils): helper functions
     for grouping and compatibility
      2 files changed, 101 insertions(+)
     ÔÇª +6 lines (ctrl+o to expand)

ÔùÅ Task 1.3: Update context types. Let me read the current ctx.ts:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ Write(apps/cli/src/types/ctx.ts)
  ÔÄ┐ ┬áAdded 7 lines, removed 6 lines
       1 -import type { Meta, StackName } from './meta';                 
       1 +// ABOUTME: Context types for template rendering and CLI flow  
       2 +// ABOUTME: AppContext for per-app config, TemplateContext for 
         + full generation                                               
       3                                                                 
       4 +import type { StackName } from './meta';                       
       5 +                                                               
       6  export interface AppContext {                                  
       7    appName: string;                                             
       8    stackName: StackName;                                        
       9 -  modules: string[];                                           
       9 +  addons: string[];                                            
      10  }                                                              
      11                                                                 
      12 -type PackageManager = 'bun' | 'npm' | 'pnpm' | undefined;      
      12 +export                                                         
         +type PackageManager = 'bun' | 'npm' | 'pnpm' | undefined;      
      13                                                                 
      14  export interface TemplateContext {                             
      15    projectName: string;                                         
      16    repo: 'single' | 'turborepo';                                
      17    apps: AppContext[];                                          
      18 -  orm?: keyof Meta['orm']['stacks'] | null;                    
      19 -  database?: keyof Meta['database']['stacks'] | null;          
      18 +  globalAddons: string[];                                      
      19    git: boolean;                                                
      20    pm?: PackageManager;                                         
      21 -  extras?: (keyof Meta['extras']['stacks'])[];                 
      21    skipInstall?: boolean;                                       
      22  }                                                              
      23                                                                 

ÔùÅ Bash(git add apps/cli/src/types/ctx.ts && git commit -m "refactor(types):
      update context types for unified addon system")
  ÔÄ┐ [refactor/template-system 03c7722] refactor(types): update context type
    s for unified addon system
     1 file changed, 7 insertions(+), 6 deletions(-)
    ÔÇª +4 lines (ctrl+o to expand)


ÔùÅ Task 1.4: Rewrite __meta__.ts. First let me read the current one to understand
   its structure:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ Now I'll write the test file first, then rewrite __meta__.ts:

ÔùÅ Write(apps/cli/tests/meta-addons.test.ts)
  ÔÄ┐ ┬áWrote 85 lines to apps/cli/tests/meta-addons.test.ts
     // ABOUTME: Validation tests for META with unified addons
     // ABOUTME: Ensures all addons have required fields and valid 
     references

     import { describe, test, expect, beforeEach } from 'bun:test';
     import { META } from '../src/__meta__';
     import { getAddonsByType, isAddonCompatible, areAddonDependenciesMet,
     clearAddonGroupsCache } from '../src/lib/addon-utils';

     beforeEach(() => {
       clearAddonGroupsCache();
     });
     ÔÇª +75 lines (ctrl+o to expand)

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && bun test
      tests/meta-addons.test.ts 2>&1 | head -30)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

     tests/meta-addons.test.ts:
     ÔÇª +33 lines (ctrl+o to expand)

ÔùÅ Test fails as expected. Now write the new __meta__.ts:

ÔùÅ Write(apps/cli/src/__meta__.ts)
  ÔÄ┐ ┬áAdded 122 lines, removed 116 lines
      1 -// ABOUTME: Single source of truth for all stacks, modules, and 
        -configuration                                                   
      2 -// ABOUTME: Contains dependencies, scripts, and metadata for    
        -project generation                                              
      1 +// ABOUTME: Single source of truth for all stacks and addons    
      2 +// ABOUTME: Unified addon system - modules, orm, database,      
        +extras all share same interface                                 
      3                                                                  
      4  import type { Meta } from '@/types/meta';                       
      5                                                                  
     ...
      101      },                                                        
      102    },                                                          
      103                                                                
      104 -  modules: {                                                  
      104 +  addons: {                                                   
      105 +    // ==================== MODULES (per-app selection)       
          +====================                                          
      106      shadcn: {                                                 
      107 +      type: 'module',                                         
      108        label: 'shadcn/ui',                                     
      109        hint: 'A set of beautifully designed components that    
           you can customize, extend, and build on',                     
      110 -      stacks: ['nextjs', 'tanstack-start'],                   
      111 -      asPackage: 'ui',                                        
      112 -      singlePath: 'src/components/ui/',                       
      110 +      support: { stacks: ['nextjs', 'tanstack-start'] },      
      111 +      destination: { target: 'package', name: 'ui',           
          +singlePath: 'src/components/ui/' },                           
      112        packageJson: {                                          
      113          dependencies: {                                       
      114            'radix-ui': '^1.4.2',                               
     ...
      129        },                                                      
      130      },                                                        
      131      'next-themes': {                                          
      132 +      type: 'module',                                         
      133        label: 'Next Themes',                                   
      134        hint: 'A library for managing themes in Next.js',       
      135 -      stacks: ['nextjs'],                                     
      135 +      support: { stacks: ['nextjs'] },                        
      136        packageJson: {                                          
      137          dependencies: {                                       
      138            'next-themes': '^0.4.6',                            
     ...
      139        },                                                      
      140      },                                                        
      141      mdx: {                                                    
      142 +      type: 'module',                                         
      143        label: 'MDX',                                           
      144        hint: 'Markdown-based content',                         
      145 -      stacks: ['nextjs'],                                     
      145 +      support: { stacks: ['nextjs'] },                        
      146        packageJson: {                                          
      147          dependencies: {                                       
      148            '@mdx-js/loader': '^3',                             
     ...
      155        },                                                      
      156      },                                                        
      157      pwa: {                                                    
      158 +      type: 'module',                                         
      159        label: 'PWA',                                           
      160        hint: 'Progressive Web App support',                    
      161 -      stacks: ['nextjs'],                                     
      161 +      support: { stacks: ['nextjs'] },                        
      162        packageJson: {},                                        
      163      },                                                        
      164      'better-auth': {                                          
      165 +      type: 'module',                                         
      166        label: 'Better Auth',                                   
      167        hint: 'The most comprehensive authentication framework  
           for TypeScript',                                              
      168 -      stacks: ['nextjs'],                                     
      169 -      asPackage: 'auth',                                      
      170 -      singlePath: 'src/lib/auth/',                            
      171 -      requires: ['orm'],                                      
      168 +      support: { stacks: ['nextjs'], addons: ['drizzle',      
          +'prisma'] },                                                  
      169 +      destination: { target: 'package', name: 'auth',         
          +singlePath: 'src/lib/auth/' },                                
      170        packageJson: {                                          
      171          dependencies: {                                       
      172            'better-auth': '^1.4.10',                           
     ...
      178        },                                                      
      179      },                                                        
      180      'tanstack-query': {                                       
      181 +      type: 'module',                                         
      182        label: 'TanStack Query',                                
      183        hint: 'Powerful asynchronous state management,          
           server-state utilities and data fetching',                    
      184 -      stacks: 'all',                                          
      184 +      support: { stacks: 'all' },                             
      185        packageJson: {                                          
      186          dependencies: {                                       
      187            '@tanstack/react-query': '^5.90.0',                 
     ...
      188        },                                                      
      189      },                                                        
      190      'tanstack-devtools': {                                    
      191 +      type: 'module',                                         
      192        label: 'TanStack Devtools',                             
      193        hint: 'Devtools panel for TanStack libraries and other  
           custom devtools',                                             
      194 -      stacks: ['nextjs', 'tanstack-start'],                   
      194 +      support: { stacks: ['nextjs', 'tanstack-start'] },      
      195        packageJson: {                                          
      196          devDependencies: {                                    
      197            '@tanstack/react-devtools': '^0.7.0',               
     ...
      199        },                                                      
      200      },                                                        
      201      'react-hook-form': {                                      
      202 +      type: 'module',                                         
      203        label: 'React Hook Form',                               
      204        hint: 'Performant, flexible and extensible forms with   
           easy-to-use validation',                                      
      205 -      stacks: ['nextjs', 'tanstack-start'],                   
      205 +      support: { stacks: ['nextjs', 'tanstack-start'] },      
      206        packageJson: {                                          
      207          dependencies: {                                       
      208            'react-hook-form': '^7.56.1',                       
     ...
      210        },                                                      
      211      },                                                        
      212      'tanstack-form': {                                        
      213 +      type: 'module',                                         
      214        label: 'TanStack Form',                                 
      215        hint: 'Headless UI for building performant and          
           type-safe forms',                                             
      216 -      stacks: ['nextjs', 'tanstack-start'],                   
      216 +      support: { stacks: ['nextjs', 'tanstack-start'] },      
      217        packageJson: {                                          
      218          dependencies: {                                       
      219            '@tanstack/react-form': '^1.23.7',                  
     ...
      220        },                                                      
      221      },                                                        
      222      nativewind: {                                             
      223 +      type: 'module',                                         
      224        label: 'NativeWind',                                    
      225        hint: 'A library for styling React Native applications  
           with Tailwind CSS',                                           
      226 -      stacks: ['expo'],                                       
      226 +      support: { stacks: ['expo'] },                          
      227        packageJson: {                                          
      228          dependencies: {                                       
      229            nativewind: '^4.1.23',                              
     ...
      233        },                                                      
      234      },                                                        
      235      'aws-lambda': {                                           
      236 +      type: 'module',                                         
      237        label: 'AWS Lambda',                                    
      238        hint: 'Serverless deployment for Hono',                 
      239 -      stacks: ['hono'],                                       
      239 +      support: { stacks: ['hono'] },                          
      240        packageJson: {                                          
      241          dependencies: {                                       
      242            '@hono/aws-lambda': '^1.0.0',                       
      243          },                                                    
      244        },                                                      
      245      },                                                        
      246 -  },                                                          
      246                                                                
      247 -  orm: {                                                      
      248 -    asPackage: 'db',                                          
      249 -    singlePath: 'src/lib/db/',                                
      250 -    requires: ['database'],                                   
      251 -    stacks: {                                                 
      252 -      drizzle: {                                              
      253 -        label: 'Drizzle',                                     
      254 -        hint: 'Lightweight TypeScript ORM',                   
      255 -        asPackage: 'db',                                      
      256 -        singlePath: 'src/lib/db/',                            
      257 -        packageJson: {                                        
      258 -          dependencies: {                                     
      259 -            'drizzle-orm': '^0.38.3',                         
      260 -          },                                                  
      261 -          devDependencies: {                                  
      262 -            'drizzle-kit': '^0.30.1',                         
      263 -          },                                                  
      264 -          scripts: {                                          
      265 -            'db:generate': 'drizzle-kit generate',            
      266 -            'db:migrate': 'drizzle-kit migrate',              
      267 -            'db:push': 'drizzle-kit push',                    
      268 -            'db:studio': 'drizzle-kit studio',                
      269 -            'db:seed': 'bun run scripts/seed.ts',             
      270 -          },                                                  
      271 -          exports: {                                          
      272 -            '.': './src/index.ts',                            
      273 -            './schema': './src/schema.ts',                    
      274 -            './types': './src/types.ts',                      
      275 -          },                                                  
      247 +    // ==================== ORM (global selection)            
          +====================                                          
      248 +    drizzle: {                                                
      249 +      type: 'orm',                                            
      250 +      label: 'Drizzle',                                       
      251 +      hint: 'Lightweight TypeScript ORM',                     
      252 +      support: { addons: ['postgres', 'mysql'] },             
      253 +      destination: { target: 'package', name: 'db',           
          +singlePath: 'src/lib/db/' },                                  
      254 +      packageJson: {                                          
      255 +        dependencies: {                                       
      256 +          'drizzle-orm': '^0.38.3',                           
      257          },                                                    
      258 +        devDependencies: {                                    
      259 +          'drizzle-kit': '^0.30.1',                           
      260 +        },                                                    
      261 +        scripts: {                                            
      262 +          'db:generate': 'drizzle-kit generate',              
      263 +          'db:migrate': 'drizzle-kit migrate',                
      264 +          'db:push': 'drizzle-kit push',                      
      265 +          'db:studio': 'drizzle-kit studio',                  
      266 +          'db:seed': 'bun run scripts/seed.ts',               
      267 +        },                                                    
      268 +        exports: {                                            
      269 +          '.': './src/index.ts',                              
      270 +          './schema': './src/schema.ts',                      
      271 +          './types': './src/types.ts',                        
      272 +        },                                                    
      273        },                                                      
      274 -      prisma: {                                               
      275 -        label: 'Prisma',                                      
      276 -        hint: 'Type-safe ORM with migrations',                
      277 -        asPackage: 'db',                                      
      278 -        singlePath: 'src/lib/db/',                            
      279 -        packageJson: {                                        
      280 -          dependencies: {                                     
      281 -            '@prisma/client': '^6.13.0',                      
      282 -          },                                                  
      283 -          devDependencies: {                                  
      284 -            prisma: '^6.13.0',                                
      285 -          },                                                  
      286 -          scripts: {                                          
      287 -            'db:generate': 'prisma generate',                 
      288 -            'db:migrate': 'prisma migrate dev',               
      289 -            'db:push': 'prisma db push',                      
      290 -            'db:studio': 'prisma studio',                     
      291 -            'db:seed': 'bun run scripts/seed.ts',             
      292 -          },                                                  
      293 -          exports: {                                          
      294 -            '.': './src/index.ts',                            
      295 -          },                                                  
      274 +    },                                                        
      275 +    prisma: {                                                 
      276 +      type: 'orm',                                            
      277 +      label: 'Prisma',                                        
      278 +      hint: 'Type-safe ORM with migrations',                  
      279 +      support: { addons: ['postgres', 'mysql'] },             
      280 +      destination: { target: 'package', name: 'db',           
          +singlePath: 'src/lib/db/' },                                  
      281 +      packageJson: {                                          
      282 +        dependencies: {                                       
      283 +          '@prisma/client': '^6.13.0',                        
      284          },                                                    
      285 +        devDependencies: {                                    
      286 +          prisma: '^6.13.0',                                  
      287 +        },                                                    
      288 +        scripts: {                                            
      289 +          'db:generate': 'prisma generate',                   
      290 +          'db:migrate': 'prisma migrate dev',                 
      291 +          'db:push': 'prisma db push',                        
      292 +          'db:studio': 'prisma studio',                       
      293 +          'db:seed': 'bun run scripts/seed.ts',               
      294 +        },                                                    
      295 +        exports: {                                            
      296 +          '.': './src/index.ts',                              
      297 +        },                                                    
      298        },                                                      
      299      },                                                        
      300 -  },                                                          
      300                                                                
      301 -  database: {                                                 
      302 -    stacks: {                                                 
      303 -      postgres: {                                             
      304 -        label: 'PostgreSQL',                                  
      305 -        hint: 'Relational database',                          
      306 -        packageJson: {                                        
      307 -          dependencies: {                                     
      308 -            pg: '^8.13.1',                                    
      309 -          },                                                  
      310 -          devDependencies: {                                  
      311 -            '@types/pg': '^8.11.10',                          
      312 -          },                                                  
      301 +    // ==================== DATABASE (global selection)       
          +====================                                          
      302 +    postgres: {                                               
      303 +      type: 'database',                                       
      304 +      label: 'PostgreSQL',                                    
      305 +      hint: 'Relational database',                            
      306 +      destination: { target: 'root' },                        
      307 +      packageJson: {                                          
      308 +        dependencies: {                                       
      309 +          pg: '^8.13.1',                                      
      310          },                                                    
      311 +        devDependencies: {                                    
      312 +          '@types/pg': '^8.11.10',                            
      313 +        },                                                    
      314        },                                                      
      315 -      mysql: {                                                
      316 -        label: 'MySQL',                                       
      317 -        hint: 'Relational database',                          
      318 -        packageJson: {                                        
      319 -          dependencies: {                                     
      320 -            mysql2: '^3.11.5',                                
      321 -          },                                                  
      315 +    },                                                        
      316 +    mysql: {                                                  
      317 +      type: 'database',                                       
      318 +      label: 'MySQL',                                         
      319 +      hint: 'Relational database',                            
      320 +      destination: { target: 'root' },                        
      321 +      packageJson: {                                          
      322 +        dependencies: {                                       
      323 +          mysql2: '^3.11.5',                                  
      324          },                                                    
      325        },                                                      
      326      },                                                        
      327 -  },                                                          
      327                                                                
      328 -  extras: {                                                   
      329 -    stacks: {                                                 
      330 -      biome: {                                                
      331 -        label: 'Biome',                                       
      332 -        hint: 'Fast linter & formatter',                      
      333 -        packageJson: {                                        
      334 -          devDependencies: {                                  
      335 -            '@biomejs/biome': '^2.3.11',                      
      336 -          },                                                  
      337 -          scripts: {                                          
      338 -            format: 'biome format --write .',                 
      339 -            lint: 'biome lint',                               
      340 -          },                                                  
      328 +    // ==================== EXTRAS (global selection)         
          +====================                                          
      329 +    biome: {                                                  
      330 +      type: 'extra',                                          
      331 +      label: 'Biome',                                         
      332 +      hint: 'Fast linter & formatter',                        
      333 +      destination: { target: 'root' },                        
      334 +      packageJson: {                                          
      335 +        devDependencies: {                                    
      336 +          '@biomejs/biome': '^2.3.11',                        
      337          },                                                    
      338 +        scripts: {                                            
      339 +          format: 'biome format --write .',                   
      340 +          lint: 'biome lint',                                 
      341 +        },                                                    
      342        },                                                      
      343 -      husky: {                                                
      344 -        label: 'Husky',                                       
      345 -        hint: 'Git hooks',                                    
      346 -        requires: ['git'],                                    
      347 -        packageJson: {                                        
      348 -          devDependencies: {                                  
      349 -            husky: '^9',                                      
      350 -          },                                                  
      351 -          scripts: {                                          
      352 -            prepare: 'husky',                                 
      353 -          },                                                  
      343 +    },                                                        
      344 +    husky: {                                                  
      345 +      type: 'extra',                                          
      346 +      label: 'Husky',                                         
      347 +      hint: 'Git hooks',                                      
      348 +      destination: { target: 'root' },                        
      349 +      packageJson: {                                          
      350 +        devDependencies: {                                    
      351 +          husky: '^9',                                        
      352          },                                                    
      353 +        scripts: {                                            
      354 +          prepare: 'husky',                                   
      355 +        },                                                    
      356        },                                                      
      357      },                                                        
      358    },                                                          

ÔùÅ Bash(bun test tests/meta-addons.test.ts 2>&1)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      9 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ Let me also run the addon-utils tests which should now pass:

ÔùÅ Bash(bun test tests/addon-utils.test.ts 2>&1)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      8 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ Bash(git add apps/cli/src/__meta__.ts apps/cli/tests/meta-addons.test.ts &&
      git commit -m "refactor(__meta__): unify modules, orm, database, extras
      into addons")
  ÔÄ┐ ┬áError: Exit code 128
     warning: could not open directory 'apps/cli/apps/cli/': No such file or 
     directory
     fatal: pathspec 'apps/cli/src/__meta__.ts' did not match any files

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add apps/cli/src/__meta__.ts
      apps/cli/tests/meta-addons.test.ts && git commit -m "refactor(__meta__):
      unify modules, oÔÇª)
  ÔÄ┐ [refactor/template-system 77011da] refactor(__meta__): unify modules, o
    rm, database, extras into addons
     2 files changed, 206 insertions(+), 116 deletions(-)
    ÔÇª +11 lines (ctrl+o to expand)


ÔùÅ Phase 1 complete. Now Phase 2: Magic Comments. Let me read the current
  magic-comments.ts:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ Now let me check the current test file:

ÔùÅ Searched for 1 pattern, read 1 file (ctrl+o to expand)

ÔùÅ I need to rewrite both the test file and the implementation. The plan
  introduces:
  - @only:turborepo|single for conditional skip
  - @dest:app|package|root (changes pkg to package)

  Let me write the new test file first:

ÔùÅ Write(apps/cli/tests/magic-comments.test.ts)
  ÔÄ┐ ┬áAdded 99 lines, removed 35 lines
       1  // ABOUTME: Unit tests for magic comments parsing              
       2 -// ABOUTME: Tests the @dest: magic comment                     
         -for destination override                                       
       2 +// ABOUTME: Tests @only: for skip and @dest:                   
         +for destination override                                       
       3                                                                 
       4 -import { describe, expect, test } from 'bun:test';             
       4 +import { describe, test, expect } from 'bun:test';             
       5  import {                                                       
       6 -  extractFirstLine,                                            
       7 -  parseDestFromContent,                                        
       6    parseMagicComments,                                          
       7 -  removeDestMagicComment,                                      
       7 +  parseDestFromContent,                                        
       8 +  parseOnlyFromContent,                                        
       9 +  shouldSkipTemplate,                                          
      10 +  removeAllMagicComments,                                      
      11 +  extractFirstLine,                                            
      12  } from '../src/lib/magic-comments';                            
      13 +import type { TemplateContext } from '../src/types/ctx';       
      14                                                                 
      15  describe('extractFirstLine', () => {                           
      16    test('extracts first line from content', () => {             
     ...
       27                                                                
       28  describe('parseMagicComments', () => {                        
       29    test('parses @dest:app', () => {                            
       30 -    const comments                                            
          - = parseMagicComments('{{!-- @dest:app --}}');                
       31 -    expect(comments).toHaveLength(1);                         
       32 -    expect(comments[0].type).toBe('dest');                    
       33 -    expect(comments[0].values).toEqual(['app']);              
       30 +    const result = parseMagicComments('{{!-- @dest:app --}}');
       31 +    expect(result.dest).toBe('app');                          
       32    });                                                         
       33                                                                
       34 -  test('parses @dest:pkg', () => {                            
       35 -    const comments = parseMagicComments('{{!-- @dest:pkg      
          - --}}');                                                      
       36 -    expect(comments).toHaveLength(1);                         
       37 -    expect(comments[0].type).toBe('dest');                    
       38 -    expect(comments[0].values).toEqual(['pkg']);              
       34 +  test('parses @dest:package', () => {                        
       35 +    const result = parseMagicComments('{{!-- @dest:package    
          + --}}');                                                      
       36 +    expect(result.dest).toBe('package');                      
       37    });                                                         
       38                                                                
       39    test('parses @dest:root', () => {                           
       40 -    const comments                                            
          - = parseMagicComments('{{!-- @dest:root --}}');               
       41 -    expect(comments).toHaveLength(1);                         
       42 -    expect(comments[0].type).toBe('dest');                    
       43 -    expect(comments[0].values).toEqual(['root']);             
       40 +    const result                                              
          + = parseMagicComments('{{!-- @dest:root --}}');               
       41 +    expect(result.dest).toBe('root');                         
       42    });                                                         
       43                                                                
       44 -  test('returns empty array for no magic comments', () => {   
       45 -    const comments = parseMagicComments('// regular           
          -comment');                                                    
       46 -    expect(comments).toHaveLength(0);                         
       44 +  test('parses @only:turborepo', () => {                      
       45 +    const result = parseMagicComments('{{!-- @only:turborepo  
          +--}}');                                                       
       46 +    expect(result.only).toBe('turborepo');                    
       47    });                                                         
       48                                                                
       49 -  test('returns empty array for empty string', () => {        
       50 -    const comments = parseMagicComments('');                  
       51 -    expect(comments).toHaveLength(0);                         
       49 +  test('parses @only:single', () => {                         
       50 +    const result = parseMagicComments('{{!-- @only:single --}}
          +');                                                           
       51 +    expect(result.only).toBe('single');                       
       52    });                                                         
       53 +                                                              
       54 +  test('parses combined @only and @dest', () => {             
       55 +    const result = parseMagicComments('{{!-- @only:turborepo  
          +@dest:package --}}');                                         
       56 +    expect(result.only).toBe('turborepo');                    
       57 +    expect(result.dest).toBe('package');                      
       58 +  });                                                         
       59 +                                                              
       60 +  test('returns empty for no magic comments', () => {         
       61 +    const result = parseMagicComments('// regular comment');  
       62 +    expect(result.dest).toBeUndefined();                      
       63 +    expect(result.only).toBeUndefined();                      
       64 +  });                                                         
       65  });                                                           
       66                                                                
       67  describe('parseDestFromContent', () => {                      
       68 -  test('extracts dest type from content', () => {             
       69 -    const content = '{{!-- @dest:app --}}\nrest of file';     
       70 -    expect(parseDestFromContent(content)).toBe('app');        
       68 +  test('extracts dest from first line', () => {               
       69 +    const content = '{{!-- @dest:root --}}\nrest of file';    
       70 +    expect(parseDestFromContent(content)).toBe('root');       
       71    });                                                         
       72                                                                
       73 -  test('returns null for no magic comment', () => {           
       74 -    const content = '// regular content\nrest of file';       
       73 +  test('returns null for no dest', () => {                    
       74 +    const content = 'no magic comment\nrest of file';         
       75      expect(parseDestFromContent(content)).toBeNull();         
       76    });                                                         
       77  });                                                           
       78                                                                
       79 -describe('removeDestMagicComment', () => {                    
       80 -  test('removes @dest: comment from content', () => {         
       81 -    const content = '{{!-- @dest:app --}}\nrest of file';     
       82 -    expect(removeDestMagicComment(content)).toBe('rest of     
          -file');                                                       
       79 +describe('parseOnlyFromContent', () => {                      
       80 +  test('extracts only from first line', () => {               
       81 +    const content = '{{!-- @only:turborepo                    
          + --}}\nrest of file';                                         
       82 +    expect(parseOnlyFromContent(content)).toBe('turborepo');  
       83    });                                                         
       84                                                                
       85 -  test('preserves content without magic comment', () => {     
       85 +  test('returns null for no only', () => {                    
       86 +    const content = '{{!-- @dest:root --}}\nrest of file';    
       87 +    expect(parseOnlyFromContent(content)).toBeNull();         
       88 +  });                                                         
       89 +});                                                           
       90 +                                                              
       91 +describe('shouldSkipTemplate', () => {                        
       92 +  const turborepoCtx: TemplateContext = {                     
       93 +    projectName: 'test',                                      
       94 +    repo: 'turborepo',                                        
       95 +    apps: [],                                                 
       96 +    globalAddons: [],                                         
       97 +    git: true,                                                
       98 +  };                                                          
       99 +                                                              
      100 +  const singleCtx: TemplateContext = {                        
      101 +    projectName: 'test',                                      
      102 +    repo: 'single',                                           
      103 +    apps: [],                                                 
      104 +    globalAddons: [],                                         
      105 +    git: true,                                                
      106 +  };                                                          
      107 +                                                              
      108 +  test('@only:turborepo skips in single', () => {             
      109 +    expect(shouldSkipTemplate('turborepo',                    
          +singleCtx)).toBe(true);                                       
      110 +    expect(shouldSkipTemplate('turborepo',                    
          +turborepoCtx)).toBe(false);                                   
      111 +  });                                                         
      112 +                                                              
      113 +  test('@only:single skips in turborepo', () => {             
      114 +    expect(shouldSkipTemplate('single',                       
          +turborepoCtx)).toBe(true);                                    
      115 +    expect(shouldSkipTemplate('single',                       
          +singleCtx)).toBe(false);                                      
      116 +  });                                                         
      117 +                                                              
      118 +  test('no @only never skips', () => {                        
      119 +    expect(shouldSkipTemplate(null,                           
          +turborepoCtx)).toBe(false);                                   
      120 +    expect(shouldSkipTemplate(null, singleCtx)).toBe(false);  
      121 +  });                                                         
      122 +});                                                           
      123 +                                                              
      124 +describe('removeAllMagicComments', () => {                    
      125 +  test('removes @dest comment', () => {                       
      126 +    const content = '{{!-- @dest:root --}}\nrest of file';    
      127 +    expect(removeAllMagicComments(content)).toBe('rest of     
          +file');                                                       
      128 +  });                                                         
      129 +                                                              
      130 +  test('removes @only comment', () => {                       
      131 +    const content = '{{!-- @only:turborepo --}}\nrest of      
          +file';                                                        
      132 +    expect(removeAllMagicComments(content)).toBe('rest of     
          +file');                                                       
      133 +  });                                                         
      134 +                                                              
      135 +  test('removes combined comments', () => {                   
      136 +    const content = '{{!-- @only:turborepo @dest:package      
          +--}}\nrest of file';                                          
      137 +    expect(removeAllMagicComments(content)).toBe('rest of     
          +file');                                                       
      138 +  });                                                         
      139 +                                                              
      140 +  test('preserves content without magic comments', () => {    
      141      const content = 'no magic comment\nrest of file';         
      142 -    expect(removeDestMagicComment                             
          -(content)).toBe('no magic comment\nrest of file');            
      142 +    expect(removeAllMagicComments                             
          +(content)).toBe('no magic comment\nrest of file');            
      143    });                                                         
      144  });                                                           

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && bun test
      tests/magic-comments.test.ts 2>&1 | head -30)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

     tests/magic-comments.test.ts:
     ÔÇª +16 lines (ctrl+o to expand)

ÔùÅ Test fails as expected. Now implement the new magic-comments.ts:

ÔùÅ Write(apps/cli/src/lib/magic-comments.ts)
  ÔÄ┐ ┬áAdded 45 lines, removed 23 lines
       1 -// ABOUTME: Magic comment parser for template                  
         -destination override                                           
       2 -// ABOUTME: Supports only @dest:app|pkg|root for explicit file 
         - placement                                                     
       1 +// ABOUTME: Magic comment parser for template processing       
       2 +// ABOUTME: Supports @only:turborepo|single for skip and       
         +@dest:app|package|root for destination                         
       3                                                                 
       4 -export type DestType = 'app' | 'pkg' | 'root';                 
       4 +import type { TemplateContext } from '@/types/ctx';            
       5                                                                 
       6 -export interface MagicComment {                                
       7 -  type: 'dest';                                                
       8 -  values: string[];                                            
       9 -  raw: string;                                                 
       6 +export type DestType = 'app' | 'package' | 'root';             
       7 +export type OnlyType = 'turborepo' | 'single';                 
       8 +                                                               
       9 +export interface ParsedMagicComments {                         
      10 +  dest?: DestType;                                             
      11 +  only?: OnlyType;                                             
      12  }                                                              
      13                                                                 
      14 +const MAGIC_COMMENT_REGEX =                                    
         +/^\{\{!--\s*((?:@(?:dest|only):[a-z]+\s*)+)--\}\}/;            
      15 +const DEST_REGEX = /@dest:(app|package|root)/;                 
      16 +const ONLY_REGEX = /@only:(turborepo|single)/;                 
      17 +                                                               
      18  export function extractFirstLine(content: string): string {    
      19    const firstLineEnd = content.indexOf('\n');                  
      20    return firstLineEnd === -1 ? content : content.slice(0,      
          firstLineEnd);                                                 
      21  }                                                              
      22                                                                 
      23 -export function parseMagicComments(firstLine: string):         
         -MagicComment[] {                                               
      24 -  const commentMatch =                                         
         -firstLine.match(/^\{\{!--\s*@dest:(app|pkg|root)\s*--\}\}/);   
      23 +export function parseMagicComments(firstLine: string):         
         +ParsedMagicComments {                                          
      24 +  const result: ParsedMagicComments = {};                      
      25                                                                 
      26 -  if (!commentMatch || !commentMatch[1]) return [];            
      26 +  const commentMatch = firstLine.match(MAGIC_COMMENT_REGEX);   
      27 +  if (!commentMatch) return result;                            
      28                                                                 
      29 -  return [                                                     
      30 -    {                                                          
      31 -      type: 'dest',                                            
      32 -      values: [commentMatch[1]],                               
      33 -      raw: commentMatch[0],                                    
      34 -    },                                                         
      35 -  ];                                                           
      29 +  const innerContent = commentMatch[1];                        
      30 +                                                               
      31 +  const destMatch = innerContent.match(DEST_REGEX);            
      32 +  if (destMatch) {                                             
      33 +    result.dest = destMatch[1] as DestType;                    
      34 +  }                                                            
      35 +                                                               
      36 +  const onlyMatch = innerContent.match(ONLY_REGEX);            
      37 +  if (onlyMatch) {                                             
      38 +    result.only = onlyMatch[1] as OnlyType;                    
      39 +  }                                                            
      40 +                                                               
      41 +  return result;                                               
      42  }                                                              
      43                                                                 
      44  export function parseDestFromContent(content: string):         
          DestType | null {                                              
      45    const firstLine = extractFirstLine(content);                 
      46 -  const comments = parseMagicComments(firstLine);              
      47 -  const firstComment = comments[0];                            
      48 -  if (!firstComment) return null;                              
      49 -  return firstComment.values[0] as DestType;                   
      46 +  const parsed = parseMagicComments(firstLine);                
      47 +  return parsed.dest ?? null;                                  
      48  }                                                              
      49                                                                 
      50 -export function removeDestMagicComment(content: string):       
         -string {                                                       
      51 -  return                                                       
         -content.replace(/^\{\{!--\s*@dest:(app|pkg|root)\s*--\}\}\n?/, 
         - '');                                                          
      50 +export function parseOnlyFromContent(content: string):         
         +OnlyType | null {                                              
      51 +  const firstLine = extractFirstLine(content);                 
      52 +  const parsed = parseMagicComments(firstLine);                
      53 +  return parsed.only ?? null;                                  
      54  }                                                              
      55 +                                                               
      56 +export function shouldSkipTemplate(only: OnlyType | null, ctx: 
         + TemplateContext): boolean {                                   
      57 +  if (!only) return false;                                     
      58 +  return only !== ctx.repo;                                    
      59 +}                                                              
      60 +                                                               
      61 +export function removeAllMagicComments(content: string):       
         +string {                                                       
      62 +  return content.replace(/^\{\{!--\s*(?:@(?:dest|only):[a-z]+\ 
         +s*)+--\}\}\n?/, '');                                           
      63 +}                                                              

ÔùÅ Bash(bun test tests/magic-comments.test.ts 2>&1)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      21 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add
      apps/cli/src/lib/magic-comments.ts apps/cli/tests/magic-comments.test.ts
      && git commit -m "feat(magic-comments): aÔÇª)
  ÔÄ┐ [refactor/template-system 156a241] feat(magic-comments): add @only:turb
    orepo|single for conditional skip
     2 files changed, 210 insertions(+), 124 deletions(-)
    ÔÇª +6 lines (ctrl+o to expand)


ÔùÅ Phase 2 complete. Now Phase 3: Template Resolver. Let me read the current
  implementation:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ I need to rewrite this file for the unified addon system. Let me first write
  the test file:

ÔùÅ Searched for 1 pattern, read 1 file (ctrl+o to expand)

ÔùÅ Now let me write the new test file based on the plan:

ÔùÅ Write(apps/cli/tests/template-resolver.test.ts)
  ÔÄ┐ ┬áAdded 49 lines, removed 80 lines
       1 -// ABOUTME: Unit tests for template resolution logic           
       2 -// ABOUTME: Tests path resolution based on META (asPackage,    
         -singlePath) and @dest:                                         
       1 +// ABOUTME: Tests for unified template resolution              
       2 +// ABOUTME: Tests destination resolution for all addon types   
       3                                                                 
       4  import { describe, test, expect } from 'bun:test';             
       5 -import { resolveDestination, resolveModuleDestination } from   
         -'../src/lib/template-resolver';                                
       5 +import { resolveAddonDestination } from                        
         +'../src/lib/template-resolver';                                
       6 +import { META } from '../src/__meta__';                        
       7  import type { TemplateContext } from '../src/types/ctx';       
       8                                                                 
       9 -const turborepoCtx: TemplateContext = {                        
      10 -  projectName: 'test',                                         
      11 -  projectPath: '/tmp/test',                                    
      12 -  repo: 'turborepo',                                           
      13 -  apps: [{ appName: 'web', stackName: 'nextjs', modules        
         -: ['shadcn'] }],                                               
      14 -};                                                             
       9 +describe('resolveAddonDestination', () => {                    
      10 +  const turborepoCtx: TemplateContext = {                      
      11 +    projectName: 'test',                                       
      12 +    repo: 'turborepo',                                         
      13 +    apps: [{ appName: 'web', stackName: 'nextjs', addons       
         +: ['shadcn'] }],                                               
      14 +    globalAddons: ['drizzle', 'postgres', 'biome'],            
      15 +    git: true,                                                 
      16 +  };                                                           
      17                                                                 
      18 -const singleCtx: TemplateContext = {                           
      19 -  projectName: 'test',                                         
      20 -  projectPath: '/tmp/test',                                    
      21 -  repo: 'single',                                              
      22 -  apps: [{ appName: 'web', stackName: 'nextjs', modules:       
         -['shadcn'] }],                                                 
      23 -};                                                             
      18 +  const singleCtx: TemplateContext = {                         
      19 +    projectName: 'test',                                       
      20 +    repo: 'single',                                            
      21 +    apps: [{ appName: 'test', stackName: 'nextjs', addons:     
         +['shadcn'] }],                                                 
      22 +    globalAddons: ['drizzle', 'postgres', 'biome'],            
      23 +    git: true,                                                 
      24 +  };                                                           
      25                                                                 
      26 -describe('resolveDestination', () => {                         
      27 -  describe('stack templates', () => {                          
      28 -    test('turborepo: resolves to apps/{appName}/', () => {     
      29 -      const result = resolveDestination('src/app/page.tsx', {  
         -type: 'stack', appName: 'web' }, turborepoCtx);                
      30 -      expect(result).toBe('apps/web/src/app/page.tsx');        
      31 -    });                                                        
      26 +  describe('destination.target = package', () => {             
      27 +    const shadcnAddon = META.addons.shadcn;                    
      28                                                                 
      29 -    test('single: resolves to root', () => {                   
      30 -      const result = resolveDestination('src/app/page.tsx', {  
         -type: 'stack', appName: 'web' }, singleCtx);                   
      31 -      expect(result).toBe('src/app/page.tsx');                 
      29 +    test('turborepo: goes to packages/{name}/', () => {        
      30 +      const result =                                           
         +resolveAddonDestination('components/button.tsx', shadcnAddon,  
         +turborepoCtx, 'web', null);                                    
      31 +      expect(result).toBe('packages/ui/components/button.tsx');
      32      });                                                        
      33 -  });                                                          
      33                                                                 
      34 -  describe('repo templates', () => {                           
      35 -    test('resolves to root', () => {                           
      36 -      const result = resolveDestination('turbo.json', { type:  
         -'repo' }, turborepoCtx);                                       
      37 -      expect(result).toBe('turbo.json');                       
      34 +    test('single: goes to singlePath', () => {                 
      35 +      const result =                                           
         +resolveAddonDestination('components/button.tsx', shadcnAddon,  
         +singleCtx, 'test', null);                                      
      36 +      expect(result).toBe('src/components/ui/components/button 
         +.tsx');                                                        
      37      });                                                        
      38 -  });                                                          
      38                                                                 
      39 -  describe('database templates', () => {                       
      40 -    test('resolves to root', () => {                           
      41 -      const result = resolveDestination('docker-compose.yml',  
         -{ type: 'database' }, turborepoCtx);                           
      42 -      expect(result).toBe('docker-compose.yml');               
      39 +    test('@dest:app override goes to app', () => {             
      40 +      const result =                                           
         +resolveAddonDestination('components.json', shadcnAddon,        
         +turborepoCtx, 'web', 'app');                                   
      41 +      expect(result).toBe('apps/web/components.json');         
      42      });                                                        
      43 -  });                                                          
      43                                                                 
      44 -  describe('extras templates', () => {                         
      45 -    test('resolves to root', () => {                           
      46 -      const result = resolveDestination('biome.json', { type:  
         -'extras' }, turborepoCtx);                                     
      47 -      expect(result).toBe('biome.json');                       
      44 +    test('@dest:root override goes to root', () => {           
      45 +      const result =                                           
         +resolveAddonDestination('drizzle.config.ts',                   
         +META.addons.drizzle, turborepoCtx, 'web', 'root');             
      46 +      expect(result).toBe('drizzle.config.ts');                
      47      });                                                        
      48    });                                                          
      49 -});                                                            
      49                                                                 
      50 -describe('resolveModuleDestination', () => {                   
      51 -  describe('module with asPackage (shadcn)', () => {           
      52 -    const moduleConfig = {                                     
      53 -      asPackage: 'ui',                                         
      54 -      singlePath: 'src/components/ui/',                        
      55 -    };                                                         
      50 +  describe('destination.target = root', () => {                
      51 +    const biomeAddon = META.addons.biome;                      
      52                                                                 
      53 -    test('turborepo: default resolves to packages/{asPackage}/ 
         -', () => {                                                     
      54 -      const result =                                           
         -resolveModuleDestination('src/components/button.tsx',          
         -moduleConfig, null, 'web', turborepoCtx);                      
      55 -                                                               
         -expect(result).toBe('packages/ui/src/components/button.tsx');  
      53 +    test('turborepo: goes to root', () => {                    
      54 +      const result = resolveAddonDestination('biome.json',     
         +biomeAddon, turborepoCtx, 'web', null);                        
      55 +      expect(result).toBe('biome.json');                       
      56      });                                                        
      57                                                                 
      58 -    test('turborepo: @dest:app overrides to apps/{appName}/',  
         -() => {                                                        
      59 -      const result =                                           
         -resolveModuleDestination('components.json', moduleConfig,      
         -'app', 'web', turborepoCtx);                                   
      60 -      expect(result).toBe('apps/web/components.json');         
      58 +    test('single: goes to root', () => {                       
      59 +      const result = resolveAddonDestination('biome.json',     
         +biomeAddon, singleCtx, 'test', null);                          
      60 +      expect(result).toBe('biome.json');                       
      61      });                                                        
      62 -                                                               
      63 -    test('turborepo: @dest:pkg explicit (same as default)', () 
         - => {                                                          
      64 -      const result =                                           
         -resolveModuleDestination('src/components/button.tsx',          
         -moduleConfig, 'pkg', 'web', turborepoCtx);                     
      65 -                                                               
         -expect(result).toBe('packages/ui/src/components/button.tsx');  
      66 -    });                                                        
      67 -                                                               
      68 -    test('turborepo: @dest:root overrides to root', () => {    
      69 -      const result =                                           
         -resolveModuleDestination('some-config.json', moduleConfig,     
         -'root', 'web', turborepoCtx);                                  
      70 -      expect(result).toBe('some-config.json');                 
      71 -    });                                                        
      72 -                                                               
      73 -    test('single: default resolves to root (template paths     
         -contain structure)', () => {                                   
      74 -      const result =                                           
         -resolveModuleDestination('src/components/button.tsx',          
         -moduleConfig, null, 'web', singleCtx);                         
      75 -      expect(result).toBe('src/components/button.tsx');        
      76 -    });                                                        
      77 -                                                               
      78 -    test('single: @dest:app resolves to root (no apps/         
         -prefix)', () => {                                              
      79 -      const result =                                           
         -resolveModuleDestination('components.json', moduleConfig,      
         -'app', 'web', singleCtx);                                      
      80 -      expect(result).toBe('components.json');                  
      81 -    });                                                        
      62    });                                                          
      63                                                                 
      64 -  describe('module without asPackage (tanstack-query)', () =>  
         -{                                                              
      65 -    const moduleConfig = {};                                   
      64 +  describe('destination.target = app (default)', () => {       
      65 +    const tanstackQueryAddon = META.addons['tanstack-query'];  
      66                                                                 
      67 -    test('turborepo: resolves to apps/{appName}/', () => {     
      68 -      const result =                                           
         -resolveModuleDestination('src/lib/query-client.ts',            
         -moduleConfig, null, 'web', turborepoCtx);                      
      69 -      expect(result).toBe('apps/web/src/lib/query-client.ts'); 
      67 +    test('turborepo: goes to apps/{appName}/', () => {         
      68 +      const result =                                           
         +resolveAddonDestination('providers/query-provider.tsx',        
         +tanstackQueryAddon, turborepoCtx, 'web', null);                
      69 +      expect(result).toBe('apps/web/providers/query-provider.  
         +tsx');                                                         
      70      });                                                        
      71                                                                 
      72 -    test('single: resolves to root', () => {                   
      73 -      const result =                                           
         -resolveModuleDestination('src/lib/query-client.ts',            
         -moduleConfig, null, 'web', singleCtx);                         
      74 -      expect(result).toBe('src/lib/query-client.ts');          
      72 +    test('single: goes to root', () => {                       
      73 +      const result =                                           
         +resolveAddonDestination('providers/query-provider.tsx',        
         +tanstackQueryAddon, singleCtx, 'test', null);                  
      74 +      expect(result).toBe('providers/query-provider.tsx');     
      75      });                                                        
      76    });                                                          
      77  });                                                            

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && bun test
      tests/template-resolver.test.ts 2>&1 | head -20)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

     tests/template-resolver.test.ts:
     ÔÇª +16 lines (ctrl+o to expand)

ÔùÅ The error is because the old template-resolver.ts imports functions that no
  longer exist in the new types/meta.ts. Let me rewrite template-resolver.ts:

ÔùÅ Write(apps/cli/src/lib/template-resolver.ts)
  ÔÄ┐ ┬áAdded 52 lines, removed 197 lines
       1 -// ABOUTME: Resolves template files to their destination paths 
       2 -// ABOUTME: Uses META config (asPackage, singlePath) and       
         -@dest: magic comments                                          
       1 +// ABOUTME: Resolves template files to destination paths       
       2 +// ABOUTME: Unified resolution for all addon types using META  
         +destination config                                             
       3                                                                 
       4 -import { readFileSync } from 'node:fs';                        
       4 +import { readFileSync, existsSync } from 'node:fs';            
       5  import { join } from 'node:path';                              
       6  import { globSync } from 'fast-glob';                          
       7  import { META } from '@/__meta__';                             
       8  import { TEMPLATES_DIR } from '@/lib/constants';               
       9  import type { TemplateContext, TemplateFile } from             
          '@/types/ctx';                                                 
      10 -import { isModuleCompatible, type                              
         -StackName } from '@/types/meta';                               
      10 +import type { MetaAddon, StackName } from '@/types/meta';      
      11 +import { isAddonCompatible } from '@/lib/addon-utils';         
      12  import { transformSpecialFilename } from './file-writer';      
      13 -import type { DestType } from './magic-comments';              
      14 -import { parseDestFromContent } from './magic-comments';       
      13 +import type { DestType, OnlyType } from './magic-comments';    
      14 +import { parseDestFromContent,                                 
         +parseOnlyFromContent, shouldSkipTemplate                       
         +} from './magic-comments';                                     
      15                                                                 
      16 -interface DestinationMeta {                                    
      17 -  type: 'stack' | 'module' | 'orm' | 'database' | 'extras' |   
         -'repo';                                                        
      18 -  appName?: string;                                            
      19 -  asPackage?: string;                                          
      20 -  singlePath?: string;                                         
      21 -}                                                              
      22 -                                                               
      23 -export function resolveDestination(                            
      16 +export function resolveAddonDestination(                       
      17    relativePath: string,                                        
      18 -  meta: DestinationMeta,                                       
      18 +  addon: MetaAddon,                                            
      19    ctx: TemplateContext,                                        
      20 -  destOverride?: DestType | null,                              
      20 +  appName: string,                                             
      21 +  destOverride: DestType | null,                               
      22  ): string {                                                    
      23    const isTurborepo = ctx.repo === 'turborepo';                
      24 +  const target = destOverride ?? addon.destination?.target ??  
         +'app';                                                         
      25                                                                 
      26 -  // Handle @dest: overrides                                   
      27 -  if (destOverride === 'root') {                               
      28 -    return relativePath;                                       
      29 -  }                                                            
      26 +  switch (target) {                                            
      27 +    case 'root':                                               
      28 +      return relativePath;                                     
      29                                                                 
      30 -  if (destOverride === 'app' && meta.appName) {                
      31 -    return isTurborepo ?                                       
         -`apps/${meta.appName}/${relativePath}` : relativePath;         
      32 -  }                                                            
      33 -                                                               
      34 -  if (destOverride === 'pkg' && meta.asPackage) {              
      35 -    return isTurborepo ?                                       
         -`packages/${meta.asPackage}/${relativePath}` : relativePath;   
      36 -  }                                                            
      37 -                                                               
      38 -  // Default behavior based on type                            
      39 -  switch (meta.type) {                                         
      40 -    case 'stack':                                              
      41 -      return isTurborepo ?                                     
         -`apps/${meta.appName}/${relativePath}` : relativePath;         
      42 -                                                               
      43 -    case 'module':                                             
      44 -      if (meta.asPackage) {                                    
      45 -        // Turborepo: files go to packages/{asPackage}/        
      46 -        // Single: files go to root (template paths contain    
         -the structure)                                                 
      47 -        return isTurborepo ?                                   
         -`packages/${meta.asPackage}/${relativePath}` : relativePath;   
      30 +    case 'package': {                                          
      31 +      if (!addon.destination || addon.destination.target !==   
         +'package') {                                                   
      32 +        return relativePath;                                   
      33        }                                                        
      34 -      return isTurborepo ?                                     
         -`apps/${meta.appName}/${relativePath}` : relativePath;         
      35 -                                                               
      36 -    case 'orm': {                                              
      37 -      // Turborepo: files go to packages/{asPackage}/          
      38 -      // Single: files go to singlePath (e.g., src/lib/db/),   
         -stripping src/ from template path                              
      34        if (isTurborepo) {                                       
      35 -        return `packages/${meta.asPackage}/${relativePath}`;   
      35 +        return `packages/${addon.destination.name              
         +}/${relativePath}`;                                            
      36        }                                                        
      37 -      // For single repo, strip leading src/ from template     
         -path since singlePath handles the structure                    
      38 -      const singlePath = relativePath.startsWith('src/') ?     
         -relativePath.slice(4) : relativePath;                          
      39 -      return `${meta.singlePath ?? ''}${singlePath}`;          
      37 +      const singlePath = addon.destination.singlePath ?? '';   
      38 +      return `${singlePath}${relativePath}`;                   
      39      }                                                          
      40                                                                 
      41 -    case 'database':                                           
      42 -    case 'extras':                                             
      43 -    case 'repo':                                               
      44 -      return relativePath;                                     
      45 -                                                               
      41 +    case 'app':                                                
      42      default:                                                   
      43 -      return relativePath;                                     
      43 +      return isTurborepo ? `apps/${appName}/${relativePath}` : 
         + relativePath;                                                 
      44    }                                                            
      45  }                                                              
      46                                                                 
      47 -export function resolveModuleDestination(                      
      48 -  relativePath: string,                                        
      49 -  moduleConfig: { asPackage?: string; singlePath?: string },   
      50 -  destOverride: DestType | null,                               
      51 -  appName: string,                                             
      52 -  ctx: TemplateContext,                                        
      53 -): string {                                                    
      54 -  return resolveDestination(                                   
      55 -    relativePath,                                              
      56 -    {                                                          
      57 -      type: 'module',                                          
      58 -      appName,                                                 
      59 -      asPackage: moduleConfig.asPackage,                       
      60 -      singlePath: moduleConfig.singlePath,                     
      61 -    },                                                         
      62 -    ctx,                                                       
      63 -    destOverride,                                              
      64 -  );                                                           
      47 +export function resolveStackDestination(relativePath: string,  
         +ctx: TemplateContext, appName: string): string {               
      48 +  const isTurborepo = ctx.repo === 'turborepo';                
      49 +  return isTurborepo ? `apps/${appName}/${relativePath}` :     
         +relativePath;                                                  
      50  }                                                              
      51                                                                 
      52  function scanTemplates(dir: string): string[] {                
      53 +  if (!existsSync(dir)) return [];                             
      54    try {                                                        
      55      return globSync('**/*', { cwd: dir, onlyFiles: true, dot:  
          true });                                                       
      56    } catch {                                                    
     ...
      102    }                                                           
      103  }                                                             
      104                                                                
      105 -function getRelativePath(file: string): string {              
      106 -  return file;                                                
      107 -}                                                             
      108 -                                                              
      105  function transformFilename(filename: string): string {        
      106    let result = filename.replace(/\.hbs$/, '');                
      107    result = transformSpecialFilename(result);                  
      108    return result;                                              
      109  }                                                             
      110                                                                
      111 -function resolveTemplatesForStack(stackName: string           
          -, appName: string, ctx: TemplateContext): TemplateFile[] {    
      111 +function resolveTemplatesForStack(stackName: StackName        
          +, appName: string, ctx: TemplateContext): TemplateFile[] {    
      112    const stackDir = join(TEMPLATES_DIR, 'stack', stackName);   
      113    const files = scanTemplates(stackDir);                      
      114    const templates: TemplateFile[] = [];                       
      115                                                                
      116    for (const file of files) {                                 
      117 -    // Skip package.json templates (generated                 
          -programmatically)                                             
      117      if (file.endsWith('package.json.hbs')) continue;          
      118                                                                
      119      const source = join(stackDir, file);                      
      120 -    const relativePath = getRelativePath(file);               
      121 -    const transformedPath = transformFilename(relativePath);  
      122 -    const destination = resolveDestination(transformedPath, { 
          - type: 'stack', appName }, ctx);                              
      120 +    const transformedPath = transformFilename(file);          
      121 +    const destination =                                       
          +resolveStackDestination(transformedPath, ctx, appName);       
      122                                                                
      123      templates.push({ source, destination });                  
      124    }                                                           
     ...
      132    return templates;                                           
      133  }                                                             
      134                                                                
      135 -function resolveTemplatesForModule(moduleName                 
          -: string, appName: string, ctx: TemplateContext):             
          -TemplateFile[] {                                              
      136 -  const mod = META.modules[moduleName];                       
      137 -  if (!mod) return [];                                        
      135 +function resolveTemplatesForAddon(addonName                   
          +: string, appName: string, ctx: TemplateContext):             
          +TemplateFile[] {                                              
      136 +  const addon = META.addons[addonName];                       
      137 +  if (!addon) return [];                                      
      138                                                                
      139 -  const app = ctx.apps.find((a) => a.appName === appName);    
      140 -  if (!app) return [];                                        
      141 -                                                              
      142 -  const moduleDir = join(TEMPLATES_DIR, 'modules',            
          -app.stackName, moduleName);                                   
      143 -  const files = scanTemplates(moduleDir);                     
      139 +  const addonDir = join(TEMPLATES_DIR, 'addons', addonName);  
      140 +  const files = scanTemplates(addonDir);                      
      141    const templates: TemplateFile[] = [];                       
      142                                                                
      143    for (const file of files) {                                 
      144 -    // Skip package.json templates (generated                 
          -programmatically)                                             
      144      if (file.endsWith('package.json.hbs')) continue;          
      145                                                                
      146 -    const source = join(moduleDir, file);                     
      146 +    const source = join(addonDir, file);                      
      147                                                                
      148 -    // Read file to check for @dest: magic comment            
      148      let destOverride: DestType | null = null;                 
      149 +    let onlyValue: OnlyType | null = null;                    
      150      try {                                                     
      151        const content = readFileSync(source, 'utf-8');          
      152        destOverride = parseDestFromContent(content);           
      153 +      onlyValue = parseOnlyFromContent(content);              
      154      } catch {                                                 
      155 -      // Can't read file, use default                         
      155 +      // Can't read file, use defaults                        
      156      }                                                         
      157                                                                
      158 -    const relativePath = getRelativePath(file);               
      159 -    const transformedPath = transformFilename(relativePath);  
      160 -    const destination = resolveModuleDestination(             
      161 -      transformedPath,                                        
      162 -      { asPackage: mod.asPackage, singlePath: mod.singlePath  
          -},                                                            
      163 -      destOverride,                                           
      164 -      appName,                                                
      165 -      ctx,                                                    
      166 -    );                                                        
      158 +    if (shouldSkipTemplate(onlyValue, ctx)) continue;         
      159                                                                
      160 -    templates.push({ source, destination });                  
      161 -  }                                                           
      160 +    const transformedPath = transformFilename(file);          
      161 +    const destination =                                       
          +resolveAddonDestination(transformedPath, addon, ctx, appName, 
          + destOverride);                                               
      162                                                                
      163 -  return templates;                                           
      164 -}                                                             
      165 -                                                              
      166 -function resolveTemplatesForOrm(ctx: TemplateContext):        
          -TemplateFile[] {                                              
      167 -  if (!ctx.orm) return [];                                    
      168 -                                                              
      169 -  const ormDir = join(TEMPLATES_DIR, 'orm', ctx.orm);         
      170 -  const files = scanTemplates(ormDir);                        
      171 -  const templates: TemplateFile[] = [];                       
      172 -                                                              
      173 -  for (const file of files) {                                 
      174 -    // Skip package.json templates (generated                 
          -programmatically)                                             
      175 -    if (file.endsWith('package.json.hbs')) continue;          
      176 -                                                              
      177 -    const source = join(ormDir, file);                        
      178 -                                                              
      179 -    let destOverride: DestType | null = null;                 
      180 -    try {                                                     
      181 -      const content = readFileSync(source, 'utf-8');          
      182 -      destOverride = parseDestFromContent(content);           
      183 -    } catch {                                                 
      184 -      // Can't read file, use default                         
      185 -    }                                                         
      186 -                                                              
      187 -    const relativePath = getRelativePath(file);               
      188 -    const transformedPath = transformFilename(relativePath);  
      189 -    const destination = resolveDestination(                   
      190 -      transformedPath,                                        
      191 -      {                                                       
      192 -        type: 'orm',                                          
      193 -        asPackage: META.orm.asPackage,                        
      194 -        singlePath: META.orm.singlePath,                      
      195 -      },                                                      
      196 -      ctx,                                                    
      197 -      destOverride,                                           
      198 -    );                                                        
      199 -                                                              
      163      templates.push({ source, destination });                  
      164    }                                                           
      165                                                                
      166    return templates;                                           
      167  }                                                             
      168                                                                
      169 -function resolveTemplatesForDatabase(ctx: TemplateContext):   
          -TemplateFile[] {                                              
      170 -  if (!ctx.database) return [];                               
      171 -                                                              
      172 -  const dbDir = join(TEMPLATES_DIR, 'database',               
          -ctx.database);                                                
      173 -  const files = scanTemplates(dbDir);                         
      174 -                                                              
      175 -  return files.map((file) => {                                
      176 -    const source = join(dbDir, file);                         
      177 -    const relativePath = getRelativePath(file);               
      178 -    const transformedPath = transformFilename(relativePath);  
      179 -    return {                                                  
      180 -      source,                                                 
      181 -      destination: resolveDestination(transformedPath, {      
          -type: 'database' }, ctx),                                     
      182 -    };                                                        
      183 -  });                                                         
      184 -}                                                             
      185 -                                                              
      186 -function resolveTemplatesForExtras(ctx: TemplateContext):     
          -TemplateFile[] {                                              
      187 -  if (!ctx.extras?.length) return [];                         
      188 -                                                              
      189 -  const templates: TemplateFile[] = [];                       
      190 -                                                              
      191 -  for (const extra of ctx.extras) {                           
      192 -    const extraDir = join(TEMPLATES_DIR, 'extras', extra);    
      193 -    const files = scanTemplates(extraDir);                    
      194 -                                                              
      195 -    for (const file of files) {                               
      196 -      const source = join(extraDir, file);                    
      197 -      const relativePath = getRelativePath(file);             
      198 -      const transformedPath =                                 
          -transformFilename(relativePath);                              
      199 -      templates.push({                                        
      200 -        source,                                               
      201 -        destination: resolveDestination(transformedPath, {    
          -type: 'extras' }, ctx),                                       
      202 -      });                                                     
      203 -    }                                                         
      204 -  }                                                           
      205 -                                                              
      206 -  return templates;                                           
      207 -}                                                             
      208 -                                                              
      169  function resolveTemplatesForRepo(ctx: TemplateContext):       
           TemplateFile[] {                                              
      170    const repoDir = join(TEMPLATES_DIR, 'repo', ctx.repo);      
      171    const files = scanTemplates(repoDir);                       
     ...
      262      .filter((file) => !file.endsWith('package.json.hbs'))     
      263      .map((file) => {                                          
      264        const source = join(repoDir, file);                     
      265 -      const relativePath = getRelativePath(file);             
      266 -      const transformedPath =                                 
          -transformFilename(relativePath);                              
      267 -      return {                                                
      268 -        source,                                               
      269 -        destination: resolveDestination(transformedPath, {    
          -type: 'repo' }, ctx),                                         
      270 -      };                                                      
      265 +      const transformedPath = transformFilename(file);        
      266 +      return { source, destination: transformedPath };        
      267      });                                                       
      268  }                                                             
      269                                                                
      270  export function getAllTemplatesForContext(ctx:                
           TemplateContext): TemplateFile[] {                            
      271    const templates: TemplateFile[] = [];                       
      272                                                                
      273 -  // 1. Repo templates (turborepo or single config files)     
      273    templates.push(...resolveTemplatesForRepo(ctx));            
      274                                                                
      275 -  // 2. Stack and module templates for each app               
      275    for (const app of ctx.apps) {                               
      276 -    // Stack templates                                        
      276      templates.push(...resolveTemplatesForStack(app.stackName, 
            app.appName, ctx));                                          
      277                                                                
      278 -    // Module templates                                       
      279 -    for (const moduleName of app.modules) {                   
      280 -      const mod = META.modules[moduleName];                   
      281 -      if (mod && isModuleCompatible(mod, app.stackName as     
          -StackName)) {                                                 
      282 -                                                              
          -templates.push(...resolveTemplatesForModule(moduleName,       
          -app.appName, ctx));                                           
      278 +    for (const addonName of app.addons) {                     
      279 +      const addon = META.addons[addonName];                   
      280 +      if (addon && isAddonCompatible(addon, app.stackName)) { 
      281 +        templates.push(...resolveTemplatesForAddon(addonName, 
          + app.appName, ctx));                                          
      282        }                                                       
      283      }                                                         
      284    }                                                           
      285                                                                
      286 -  templates.push(...resolveTemplatesForOrm(ctx));             
      287 -  templates.push(...resolveTemplatesForDatabase(ctx));        
      288 -  templates.push(...resolveTemplatesForExtras(ctx));          
      286 +  const defaultAppName = ctx.apps[0]?.appName ??              
          +ctx.projectName;                                              
      287 +  for (const addonName of ctx.globalAddons) {                 
      288 +    templates.push(...resolveTemplatesForAddon(addonName,     
          +defaultAppName, ctx));                                        
      289 +  }                                                           
      290                                                                
      291    return templates;                                           
      292  }                                                             

ÔùÅ Bash(bun test tests/template-resolver.test.ts 2>&1)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      8 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add
      apps/cli/src/lib/template-resolver.ts
      apps/cli/tests/template-resolver.test.ts && git commit -m
      "refactor(templateÔÇª)
  ÔÄ┐ [refactor/template-system f53eff0] refactor(template-resolver): unified
     resolution for all addon types
     2 files changed, 231 insertions(+), 407 deletions(-)
    ÔÇª +13 lines (ctrl+o to expand)


ÔùÅ Phase 3 complete. Now Phase 4: Package.json Generator. Let me check if it
  exists and read it:

ÔùÅ Searched for 1 pattern, read 1 file (ctrl+o to expand)

ÔùÅ This file uses META.modules, META.orm, META.database, META.extras which no
  longer exist. Let me check if there's a test file:

ÔùÅ Searched for 1 pattern, read 1 file (ctrl+o to expand)

ÔùÅ I need to update the test file to use the new context structure (addons
  instead of modules, globalAddons instead of orm/database/extras), then rewrite
   the implementation. Let me write the updated test file:

ÔùÅ Write(apps/cli/tests/package-json-generator.test.ts)
  ÔÄ┐ ┬áAdded 23 lines, removed 115 lines
       1 -// ABOUTME: Unit tests for programmatic package.json generation
       2 -// ABOUTME: Tests merge logic, workspace references, and port  
         -resolution                                                     
       1 +// ABOUTME: Tests for programmatic package.json generation     
       2 +// ABOUTME: Tests merge logic with unified addons              
       3                                                                 
       4 -import { describe, expect, test } from 'bun:test';             
       4 +import { describe, test, expect } from 'bun:test';             
       5  import {                                                       
       6    generateAllPackageJsons,                                     
       7    generateAppPackageJson,                                      
       8    generatePackagePackageJson,                                  
       9 -  generateRootPackageJson,                                     
       9    mergePackageJsonConfigs,                                     
      10  } from '../src/lib/package-json-generator';                    
      11  import type { TemplateContext } from '../src/types/ctx';       
     ...
      21      const result = mergePackageJsonConfigs({ dependencies: {   
          a: '1.0.0' } }, { dependencies: { a: '2.0.0' } });             
      22      expect(result.dependencies?.a).toBe('2.0.0');              
      23    });                                                          
      24 -                                                               
      25 -  test('merges devDependencies and scripts', () => {           
      26 -    const result = mergePackageJsonConfigs(                    
      27 -      { devDependencies: { a: '1' }, scripts: { dev: 'dev1' }  
         -},                                                             
      28 -      { devDependencies: { b: '2' }, scripts: { build:         
         -'build1' } },                                                  
      29 -    );                                                         
      30 -    expect(result.devDependencies).toEqual({ a: '1', b: '2'    
         -});                                                            
      31 -    expect(result.scripts).toEqual({ dev: 'dev1', build:       
         -'build1' });                                                   
      32 -  });                                                          
      24  });                                                            
      25                                                                 
      26  describe('generateAppPackageJson (turborepo)', () => {         
     ...
      37      projectName: 'test-project',                               
      38      repo: 'turborepo',                                         
      39      apps: [                                                    
      40 -      { appName: 'web', stackName: 'nextjs', modules           
         -: ['shadcn'] },                                                
      41 -      { appName: 'api', stackName: 'hono', modules: [] },      
      40 +      { appName: 'web', stackName: 'nextjs', addons            
         +: ['shadcn'] },                                                
      41 +      { appName: 'api', stackName: 'hono', addons: [] },       
      42      ],                                                         
      43 -    orm: 'drizzle',                                            
      44 -    database: 'postgres',                                      
      45 -    git: false,                                                
      43 +    globalAddons: ['drizzle', 'postgres'],                     
      44 +    git: true,                                                 
      45    };                                                           
      46                                                                 
      47    test('generates correct name and path', () => {              
     ...
      57      expect(result.content.dependencies?.react).toBeDefined();  
      58    });                                                          
      59                                                                 
      60 -  test('references workspace packages for modules with         
         -asPackage', () => {                                            
      60 +  test('references workspace packages for addons with          
         +package destination', () => {                                  
      61      const result = generateAppPackageJson(ctx.apps[0], ctx,    
          0);                                                            
      62                                                                 
          expect(result.content.dependencies?.['@repo/ui']).toBe('*');   
      63      expect(result.content.dependencies?.['radix-ui']).toBeUnde 
          fined();                                                       
      64    });                                                          
      65                                                                 
      66 -  test('references @repo/db when orm is set', () => {          
      66 +  test('references @repo/db when orm addon is selected         
         +', () => {                                                     
      67      const result = generateAppPackageJson(ctx.apps[0], ctx,    
          0);                                                            
      68                                                                 
          expect(result.content.dependencies?.['@repo/db']).toBe('*');   
      69    });                                                          
     ...
      71    test('resolves port placeholder in scripts', () => {         
      72      const result = generateAppPackageJson(ctx.apps[0], ctx,    
          0);                                                            
      73      expect(result.content.scripts?.dev).toContain('--port      
          3000');                                                        
      74 -                                                               
      75 -    const result2 = generateAppPackageJson(ctx.apps[1], ctx,   
         -1);                                                            
      76 -    expect(result2.content.scripts?.dev).not.toContain('{{port 
         -}}');                                                          
      74    });                                                          
      75 -                                                               
      76 -  test('second app gets port 3001', () => {                    
      77 -    const result = generateAppPackageJson(ctx.apps[1], ctx,    
         -1);                                                            
      78 -    expect(result.content.name).toBe('api');                   
      79 -  });                                                          
      75  });                                                            
      76                                                                 
      77  describe('generateAppPackageJson (single repo)', () => {       
      78    const ctx: TemplateContext = {                               
      79      projectName: 'test-single',                                
      80      repo: 'single',                                            
      81 -    apps: [{ appName: 'web', stackName: 'nextjs', modules      
         -: ['shadcn'] }],                                               
      82 -    orm: 'drizzle',                                            
      83 -    database: 'postgres',                                      
      84 -    extras: ['biome'],                                         
      85 -    git: false,                                                
      81 +    apps: [{ appName: 'test-single', stackName: 'nextjs',      
         +addons: ['shadcn'] }],                                         
      82 +    globalAddons: ['drizzle', 'postgres', 'biome'],            
      83 +    git: true,                                                 
      84    };                                                           
      85                                                                 
      86    test('generates at root with project name', () => {          
     ...
       99      expect(result.content.name).toBe('test-single');          
      100    });                                                         
      101                                                                
      102 -  test('includes module                                       
          - dependencies directly (no workspace)', () => {               
      102 +  test('includes addon                                        
          + dependencies directly (no workspace)', () => {               
      103      const result = generateAppPackageJson(ctx.apps[0], ctx,   
           0);                                                           
      104      expect(result.content.dependencies?.['radix-ui']).toBeDef 
           ined();                                                       
      105      expect(result.content.dependencies?.['@repo/ui']).toBeUnd 
           efined();                                                     
      106    });                                                         
      107                                                                
      108 -  test('includes orm dependencies directly', () => {          
      108 +  test('includes orm and database                             
          +dependencies directly', () => {                               
      109      const result = generateAppPackageJson(ctx.apps[0], ctx,   
           0);                                                           
      110      expect(result.content.dependencies?.['drizzle-orm']).toBe 
           Defined();                                                    
      111 -    expect(result.content.devDependencies?.['drizzle-kit']    
          -).toBeDefined();                                              
      111 +    expect(result.content.dependencies?.pg).toBeDefined();    
      112      expect(result.content.scripts?.['db:generate']).toBeDefin 
           ed();                                                         
      113    });                                                         
      114                                                                
      115 -  test('includes database driver', () => {                    
      116 -    const result = generateAppPackageJson(ctx.apps[0], ctx,   
          -0);                                                           
      117 -    expect(result.content.dependencies?.pg).toBeDefined();    
      118 -  });                                                         
      119 -                                                              
      115    test('includes extras', () => {                             
      116      const result = generateAppPackageJson(ctx.apps[0], ctx,   
           0);                                                           
      117      expect(result.content.devDependencies?.['@biomejs/biome'] 
           ).toBeDefined();                                              
      118      expect(result.content.scripts?.format).toBeDefined();     
      119    });                                                         
      120 -                                                              
      121 -  test('does not include port in scripts (single app)', () => 
          - {                                                            
      122 -    const result = generateAppPackageJson(ctx.apps[0], ctx,   
          -0);                                                           
      123 -                                                              
          -expect(result.content.scripts?.dev).not.toContain('--port');  
      124 -  });                                                         
      120  });                                                           
      121                                                                
      122 -describe('generatePackagePackageJson', () => {                
      123 -  test('generates ui package with correct exports', () => {   
      124 -    const result = generatePackagePackageJson('ui', {         
      125 -      dependencies: { 'radix-ui': '^1.0.0' },                 
      126 -      exports: { './': './src/components/' },                 
      127 -    });                                                       
      128 -                                                              
      129 -    expect(result.path).toBe('packages/ui/package.json');     
      130 -    expect(result.content.name).toBe('@repo/ui');             
      131 -    expect(result.content.exports).toEqual({ './':            
          -'./src/components/' });                                       
      132 -    expect(result.content.dependencies?.['radix-ui']).toBe('^ 
          -1.0.0');                                                      
      133 -  });                                                         
      134 -                                                              
      135 -  test('generates db package with scripts', () => {           
      136 -    const result = generatePackagePackageJson('db', {         
      137 -      dependencies: { 'drizzle-orm': '^0.38.0' },             
      138 -      scripts: { 'db:generate': 'drizzle-kit generate' },     
      139 -      exports: { '.': './src/index.ts' },                     
      140 -    });                                                       
      141 -                                                              
      142 -    expect(result.content.name).toBe('@repo/db');             
      143 -    expect(result.content.scripts?.['db:generate']).toBeDefin 
          -ed();                                                         
      144 -  });                                                         
      145 -});                                                           
      146 -                                                              
      147 -describe('generateRootPackageJson (turborepo)', () => {       
      148 -  const ctx: TemplateContext = {                              
      149 -    projectName: 'my-monorepo',                               
      150 -    repo: 'turborepo',                                        
      151 -    apps: [                                                   
      152 -      { appName: 'web', stackName: 'nextjs', modules: [] },   
      153 -      { appName: 'api', stackName: 'hono', modules: [] },     
      154 -    ],                                                        
      155 -    extras: ['biome'],                                        
      156 -    git: false,                                               
      157 -  };                                                          
      158 -                                                              
      159 -  test('generates root package.json with project name', () => 
          - {                                                            
      160 -    const result = generateRootPackageJson(ctx);              
      161 -    expect(result.path).toBe('package.json');                 
      162 -    expect(result.content.name).toBe('my-monorepo');          
      163 -  });                                                         
      164 -                                                              
      165 -  test('includes workspaces', () => {                         
      166 -    const result = generateRootPackageJson(ctx);              
      167 -    expect(result.content.workspaces).toContain('apps/*');    
      168 -                                                              
          -expect(result.content.workspaces).toContain('packages/*');    
      169 -  });                                                         
      170 -                                                              
      171 -  test('includes turborepo scripts', () => {                  
      172 -    const result = generateRootPackageJson(ctx);              
      173 -    expect(result.content.scripts?.dev).toContain('turbo');   
      174 -    expect(result.content.scripts?.build).toContain('turbo'); 
      175 -  });                                                         
      176 -                                                              
      177 -  test('includes extras devDependencies', () => {             
      178 -    const result = generateRootPackageJson(ctx);              
      179 -    expect(result.content.devDependencies?.['@biomejs/biome'] 
          -).toBeDefined();                                              
      180 -  });                                                         
      181 -});                                                           
      182 -                                                              
      122  describe('generateAllPackageJsons', () => {                   
      123 -  test('generates all required                                
          -package.jsons for turborepo', () => {                         
      123 +  test('generates all package.jsons for turborepo', () => {   
      124      const ctx: TemplateContext = {                            
      125        projectName: 'test',                                    
      126        repo: 'turborepo',                                      
      127        apps: [                                                 
      128 -        { appName: 'web', stackName: 'nextjs', modules        
          -: ['shadcn'] },                                               
      129 -        { appName: 'api', stackName: 'hono', modules: [] },   
      128 +        { appName: 'web', stackName: 'nextjs', addons         
          +: ['shadcn'] },                                               
      129 +        { appName: 'api', stackName: 'hono', addons: [] },    
      130        ],                                                      
      131 -      orm: 'drizzle',                                         
      132 -      database: 'postgres',                                   
      133 -      git: false,                                             
      131 +      globalAddons: ['drizzle', 'postgres'],                  
      132 +      git: true,                                              
      133      };                                                        
      134                                                                
      135      const results = generateAllPackageJsons(ctx);             
     ...
      218      const ctx: TemplateContext = {                            
      219        projectName: 'test-single',                             
      220        repo: 'single',                                         
      221 -      apps: [{ appName: 'web', stackName: 'nextjs', modules   
          -: [] }],                                                      
      222 -      git: false,                                             
      221 +      apps: [{ appName: 'test-single', stackName: 'nextjs',   
          +addons: [] }],                                                
      222 +      globalAddons: [],                                       
      223 +      git: true,                                              
      224      };                                                        
      225                                                                
      226      const results = generateAllPackageJsons(ctx);             

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && bun test
      tests/package-json-generator.test.ts 2>&1 | head -30)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

     tests/package-json-generator.test.ts:
     ÔÇª +16 lines (ctrl+o to expand)

ÔùÅ Good, test fails because the implementation still uses old imports. Now let me
   rewrite the implementation:

ÔùÅ Write(apps/cli/src/lib/package-json-generator.ts)
  ÔÄ┐ ┬áAdded 67 lines, removed 39 lines
       1  // ABOUTME: Programmatic generation of package.json files      
       2 -// ABOUTME: Merges dependencies from META based on context     
         -(stacks, modules, orm, extras)                                 
       2 +// ABOUTME: Merges dependencies from META based on unified     
         +addon system                                                   
       3                                                                 
       4  import { META } from '@/__meta__';                             
       5 -import type { PackageJsonConfig, StackName                     
         -} from '@/types/meta';                                         
       5 +import type { PackageJsonConfig } from '@/types/meta';         
       6  import type { AppContext, TemplateContext } from               
          '@/types/ctx';                                                 
       7 -import { isModuleCompatible } from '@/types/meta';             
       7 +import { isAddonCompatible, getAddonsByType } from             
         +'@/lib/addon-utils';                                           
       8                                                                 
       9  export interface PackageJson {                                 
      10    name: string;                                                
     ...
      70    return sorted;                                               
      71  }                                                              
      72                                                                 
      73 +function hasPackageDestination(addonName: string): string |    
         +null {                                                         
      74 +  const addon = META.addons[addonName];                        
      75 +  if (addon?.destination?.target === 'package') {              
      76 +    return addon.destination.name;                             
      77 +  }                                                            
      78 +  return null;                                                 
      79 +}                                                              
      80 +                                                               
      81  export function generateAppPackageJson(app: AppContext, ctx:   
          TemplateContext, appIndex: number): GeneratedPackageJson {     
      82    const stack = META.stacks[app.stackName];                    
      83    const port = 3000 + appIndex;                                
     ...
       77                                                                
       78    let merged = mergePackageJsonConfigs(stack.packageJson);    
       79                                                                
       80 -  for (const moduleName of app.modules) {                     
       81 -    const mod = META.modules[moduleName];                     
       82 -    if (!mod || !isModuleCompatible(mod                       
          -, app.stackName)) continue;                                   
       80 +  for (const addonName of app.addons) {                       
       81 +    const addon = META.addons[addonName];                     
       82 +    if (!addon || !isAddonCompatible(addon                    
          +, app.stackName)) continue;                                   
       83                                                                
       84 -    if (mod.asPackage && isTurborepo) {                       
       84 +    const packageName = hasPackageDestination(addonName);     
       85 +    if (packageName && isTurborepo) {                         
       86        merged.dependencies = {                                 
       87          ...merged.dependencies,                               
       88 -        [`@repo/${mod.asPackage}`]: '*',                      
       88 +        [`@repo/${packageName}`]: '*',                        
       89        };                                                      
       90      } else {                                                  
       91 -      merged = mergePackageJsonConfigs(merged, mod            
          -.packageJson);                                                
       91 +      merged = mergePackageJsonConfigs(merged, addon          
          +.packageJson);                                                
       92      }                                                         
       93    }                                                           
       94                                                                
       95 -  if (ctx.orm) {                                              
       96 -    if (isTurborepo) {                                        
       95 +  for (const addonName of ctx.globalAddons) {                 
       96 +    const addon = META.addons[addonName];                     
       97 +    if (!addon) continue;                                     
       98 +                                                              
       99 +    const packageName = hasPackageDestination(addonName);     
      100 +                                                              
      101 +    if (packageName && isTurborepo) {                         
      102        merged.dependencies = {                                 
      103          ...merged.dependencies,                               
      104 -        '@repo/db': '*',                                      
      104 +        [`@repo/${packageName}`]: '*',                        
      105        };                                                      
      106 -    } else {                                                  
      107 -      const ormConfig = META.orm.stacks[ctx.orm].packageJson; 
      108 -      const dbConfig = ctx.database ?                         
          -META.database.stacks[ctx.database].packageJson : undefined;   
      109 -      merged = mergePackageJsonConfigs(merged, ormConfig,     
          -dbConfig);                                                    
      106 +    } else if (!isTurborepo || addon.destination?.target ===  
          +'root') {                                                     
      107 +      merged = mergePackageJsonConfigs(merged,                
          +addon.packageJson);                                           
      108      }                                                         
      109    }                                                           
      110                                                                
      111 -  if (!isTurborepo && ctx.extras) {                           
      112 -    for (const extra of ctx.extras) {                         
      113 -      const extraConfig =                                     
          -META.extras.stacks[extra]?.packageJson;                       
      114 -      merged = mergePackageJsonConfigs(merged, extraConfig);  
      111 +  if (!isTurborepo) {                                         
      112 +    for (const addonName of ctx.globalAddons) {               
      113 +      const addon = META.addons[addonName];                   
      114 +      if (addon?.type === 'extra') {                          
      115 +        merged = mergePackageJsonConfigs(merged,              
          +addon.packageJson);                                           
      116 +      }                                                       
      117      }                                                         
      118    }                                                           
      119                                                                
     ...
      164      turbo: '^2.4.0',                                          
      165    };                                                          
      166                                                                
      167 -  if (ctx.extras) {                                           
      168 -    for (const extra of ctx.extras) {                         
      169 -      const extraConfig =                                     
          -META.extras.stacks[extra]?.packageJson;                       
      170 -      if (extraConfig) {                                      
      171 -        if (extraConfig.devDependencies) {                    
      172 -          devDependencies = { ...devDependencies,             
          -...extraConfig.devDependencies };                             
      173 -        }                                                     
      174 -        if (extraConfig.scripts) {                            
      175 -          Object.assign(scripts, extraConfig.scripts);        
      176 -        }                                                     
      167 +  for (const addonName of ctx.globalAddons) {                 
      168 +    const addon = META.addons[addonName];                     
      169 +    if (addon?.type === 'extra' && addon.packageJson) {       
      170 +      if (addon.packageJson.devDependencies) {                
      171 +        devDependencies = { ...devDependencies,               
          +...addon.packageJson.devDependencies };                       
      172        }                                                       
      173 +      if (addon.packageJson.scripts) {                        
      174 +        Object.assign(scripts, addon.packageJson.scripts);    
      175 +      }                                                       
      176      }                                                         
      177    }                                                           
      178                                                                
     ...
      204      const extractedPackages = new Map<string,                 
           PackageJsonConfig>();                                         
      205                                                                
      206      for (const app of ctx.apps) {                             
      207 -      for (const moduleName of app.modules) {                 
      208 -        const mod = META.modules[moduleName];                 
      209 -        if (mod?.asPackage &&                                 
          -!extractedPackages.has(mod.asPackage)) {                      
      210 -          extractedPackages.set(mod.asPackage,                
          -mod.packageJson);                                             
      207 +      for (const addonName of app.addons) {                   
      208 +        const addon = META.addons[addonName];                 
      209 +        if (addon?.destination?.target === 'package') {       
      210 +          const pkgName = addon.destination.name;             
      211 +          if (!extractedPackages.has(pkgName)) {              
      212 +            extractedPackages.set(pkgName, addon.packageJson  
          +?? {});                                                       
      213 +          }                                                   
      214          }                                                     
      215        }                                                       
      216      }                                                         
      217                                                                
      218 -    if (ctx.orm) {                                            
      219 -      const ormConfig = META.orm.stacks[ctx.orm].packageJson; 
      220 -      const dbConfig = ctx.database ?                         
          -META.database.stacks[ctx.database].packageJson : undefined;   
      221 -      const merged = mergePackageJsonConfigs(ormConfig,       
          -dbConfig);                                                    
      222 -      extractedPackages.set('db', merged);                    
      218 +    const ormAddons = ctx.globalAddons.filter((n) =>          
          +META.addons[n]?.type === 'orm');                              
      219 +    const dbAddons = ctx.globalAddons.filter((n) =>           
          +META.addons[n]?.type === 'database');                         
      220 +                                                              
      221 +    if (ormAddons.length > 0) {                               
      222 +      const ormAddon = META.addons[ormAddons[0]];             
      223 +      if (ormAddon?.destination?.target === 'package') {      
      224 +        const pkgName = ormAddon.destination.name;            
      225 +        let config = ormAddon.packageJson ?? {};              
      226 +                                                              
      227 +        for (const dbName of dbAddons) {                      
      228 +          const dbAddon = META.addons[dbName];                
      229 +          if (dbAddon?.packageJson) {                         
      230 +            config = mergePackageJsonConfigs(config,          
          +dbAddon.packageJson);                                         
      231 +          }                                                   
      232 +        }                                                     
      233 +                                                              
      234 +        extractedPackages.set(pkgName, config);               
      235 +      }                                                       
      236      }                                                         
      237                                                                
      238      for (const [name, config] of extractedPackages) {         

ÔùÅ Bash(bun test tests/package-json-generator.test.ts 2>&1)
  ÔÄ┐ ┬ábun test v1.3.3 (274e01c7)

      13 pass
     ÔÇª +3 lines (ctrl+o to expand)

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add
      apps/cli/src/lib/package-json-generator.ts
      apps/cli/tests/package-json-generator.test.ts && git commit -m "refactoÔÇª)
  ÔÄ┐ [refactor/template-system 612709d] refactor(package-json-generator): su
    pport unified addon system
     2 files changed, 90 insertions(+), 154 deletions(-)
    ÔÇª +4 lines (ctrl+o to expand)


ÔùÅ Phase 4 complete. Now Phase 5: CLI and Prompts. Let me read flags.ts:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ This file references META.modules, META.database, META.orm, META.extras which
  no longer exist. Let me rewrite it based on the plan:

ÔùÅ Write(apps/cli/src/flags.ts)
  ÔÄ┐ ┬áAdded 59 lines, removed 114 lines
       1 +// ABOUTME: CLI flags parser for non-interactive mode          
       2 +// ABOUTME: Parses --app and --addon flags into                
         +TemplateContext                                                
       3 +                                                               
       4  import { Command } from 'commander';                           
       5  import color from 'picocolors';                                
       6  import { META } from '@/__meta__';                             
       7  import { ASCII } from '@/lib/constants';                       
       8  import type { AppContext, TemplateContext } from               
          '@/types/ctx';                                                 
       9 -import { isModuleCompatible, type                              
         -StackName } from '@/types/meta';                               
       9 +import type { StackName } from '@/types/meta';                 
      10 +import { isAddonCompatible, getAddonsByType,                   
         +areAddonDependenciesMet } from '@/lib/addon-utils';            
      11                                                                 
      12  interface ParsedFlags {                                        
      13    projectName?: string;                                        
      14    app?: string[];                                              
      15 -  database?: string | boolean;                                 
      16 -  orm?: string | boolean;                                      
      15 +  addon?: string[];                                            
      16    git?: boolean;                                               
      17    pm?: string;                                                 
      18 -  extras?: string | boolean;                                   
      18    install?: boolean;                                           
      19  }                                                              
      20                                                                 
      21  export function parseFlags(): Partial<TemplateContext> {       
      22    const program = new Command();                               
      23                                                                 
      24 +  const addonGroups = getAddonsByType(META);                   
      25 +  const ormNames = addonGroups.orm?.join(', ') ?? '';          
      26 +  const dbNames = addonGroups.database?.join(', ') ?? '';      
      27 +  const extraNames = addonGroups.extra?.join(', ') ?? '';      
      28 +                                                               
      29    program                                                      
      30      .addHelpText('before', ASCII)                              
      31      .name(color.blue('npx create-faster'))                     
     ...
      27      .argument('[project-name]', 'Name of the project to        
          create')                                                       
      28      .optionsGroup(color.bold('Options:'))                      
      29      .helpOption('--help', 'Display help for command')          
      30 -    .option('--app <name:stack:modules>', 'Add app             
         -in format name:stack:module1,module2                           
         -(repeatable)', collect, [])                                    
      31 -    .option('--database <name>', 'Database provider (postgres, 
         - mysql)')                                                      
      32 -    .option('--no-database', 'Skip database setup')            
      33 -    .option('--orm <name>', 'ORM provider (prisma, drizzle)')  
      34 -    .option('--no-orm', 'Skip ORM setup')                      
      30 +    .option('--app <name:stack:addons>', 'Add app              
         +(repeatable)', collect, [])                                    
      31 +    .option('--addon <name>', 'Add global addon (repeatable)', 
         + collect, [])                                                  
      32      .option('--git', 'Initialize git repository')              
      33      .option('--no-git', 'Skip git initialization')             
      34      .option('--pm <manager>', 'Package manager (bun, npm,      
          pnpm)')                                                        
      35 -    .option('--extras <items>', 'Comma-separated extras        
         -(biome, husky)')                                               
      36 -    .option('--no-extras', 'Skip extras')                      
      35      .option('--no-install', 'Skip dependency installation')    
      36      .addHelpText(                                              
      37        'after',                                                 
     ...
      44  ${color.bold('Examples:')}                                     
      45    ${color.gray('Single app:')}                                 
      46      $ ${color.blue('npx create-faster myapp')} --app           
          myapp:nextjs:shadcn,tanstack-query                             
      47 -    $ ${color.blue('npx create-faster mysaas')} --app          
         -mysaas:nextjs --database postgres --orm drizzle --git          
      47 +    $ ${color.blue('npx create-faster mysaas')} --app          
         +mysaas:nextjs --addon drizzle --addon postgres --git           
      48                                                                 
      49    ${color.gray('Multi apps (turborepo):')}                     
      50 -    $ ${color.blue('npx create-faster myapp')} --app           
         -web:nextjs:shadcn,mdx --app mobile:expo:nativewind             
      51 -    $ ${color.blue('npx create-faster mysaas')} --app          
         -web:nextjs --app api:hono --database postgres --orm drizzle    
      50 +    $ ${color.blue('npx create-faster myapp')} --app           
         +web:nextjs:shadcn --app mobile:expo:nativewind                 
      51 +    $ ${color.blue('npx create-faster mysaas')} --app          
         +web:nextjs --app api:hono --addon drizzle --addon postgres     
      52                                                                 
      53    ${color.gray('Available stacks:')}                           
          ${Object.keys(META.stacks).join(', ')}                         
      54 -  ${color.gray('Available databases:')}                        
         -${Object.keys(META.database.stacks).join(', ')}                
      55 -  ${color.gray('Available ORMs:')}                             
         -${Object.keys(META.orm.stacks).join(', ')}                     
      54 +  ${color.gray('Available ORMs:')} ${ormNames}                 
      55 +  ${color.gray('Available databases:')} ${dbNames}             
      56 +  ${color.gray('Available extras:')} ${extraNames}             
      57  `,                                                             
      58      )                                                          
      59      .allowUnknownOption(false)                                 
     ...
       63    const flags = program.opts<ParsedFlags>();                  
       64    const projectName = program.args[0];                        
       65                                                                
       66 -  // If no flags provided, return empty partial (full         
          -interactive mode)                                             
       66    if (Object.keys(flags).length === 0 && !projectName) {      
       67      return {};                                                
       68    }                                                           
       69                                                                
       70    const partial: Partial<TemplateContext> = {};               
       71                                                                
       72 -  // Project name                                             
       72    if (projectName) {                                          
       73      partial.projectName = projectName;                        
       74    }                                                           
       75                                                                
       76 -  // Apps configuration                                       
       76    if (flags.app && flags.app.length > 0) {                    
       77      partial.apps = flags.app.map((appFlag) =>                 
           parseAppFlag(appFlag));                                       
       78    }                                                           
       79                                                                
       80 -  // Database (--database <name> or --no-database)            
       81 -  if (flags.database === false) {                             
       82 -    partial.database = null;                                  
       83 -  } else if (typeof flags.database === 'string') {            
       84 -    if (!isValidKey(flags.database, META.database.stacks)) {  
       85 -      printError(`Invalid database '${flags.database}'`,      
          -`Available databases:                                         
          -${formatOptions(META.database.stacks)}`);                     
       86 -      process.exit(1);                                        
       80 +  if (flags.addon && flags.addon.length > 0) {                
       81 +    partial.globalAddons = [];                                
       82 +    for (const addonName of flags.addon) {                    
       83 +      if (!META.addons[addonName]) {                          
       84 +        printError(`Invalid addon '${addonName}'`, `Available 
          + addons: ${Object.keys(META.addons).join(', ')}`);            
       85 +        process.exit(1);                                      
       86 +      }                                                       
       87 +      partial.globalAddons.push(addonName);                   
       88      }                                                         
       89 -    partial.database = flags.database as keyof typeof         
          -META.database.stacks;                                         
       89    }                                                           
       90                                                                
       91 -  // ORM (--orm <name> or --no-orm)                           
       92 -  if (flags.orm === false) {                                  
       93 -    partial.orm = null;                                       
       94 -  } else if (typeof flags.orm === 'string') {                 
       95 -    if (!isValidKey(flags.orm, META.orm.stacks)) {            
       96 -      printError(`Invalid ORM '${flags.orm}'`, `Available     
          -ORMs: ${formatOptions(META.orm.stacks)}`);                    
       97 -      process.exit(1);                                        
       98 -    }                                                         
       99 -    partial.orm = flags.orm as keyof typeof META.orm.stacks;  
      100 -  }                                                           
      101 -                                                              
      102 -  // Git (--git or --no-git)                                  
       91    if (flags.git !== undefined) {                              
       92      partial.git = flags.git;                                  
       93    }                                                           
       94                                                                
       95 -  // Package manager                                          
       95    if (flags.pm) {                                             
       96      const validPms = ['bun', 'npm', 'pnpm'];                  
       97      if (!validPms.includes(flags.pm)) {                       
     ...
      117      partial.pm = flags.pm as 'bun' | 'npm' | 'pnpm';          
      118    }                                                           
      119                                                                
      120 -  // Extras (--extras <items> or --no-extras)                 
      121 -  if (flags.extras === false) {                               
      122 -    partial.extras = [];                                      
      123 -  } else if (typeof flags.extras === 'string') {              
      124 -    const extrasList = flags.extras.split(',').map((e) =>     
          -e.trim());                                                    
      125 -    for (const extra of extrasList) {                         
      126 -      if (!isValidKey(extra, META.extras.stacks)) {           
      127 -        printError(`Invalid extra '${extra}'`, `Available     
          -extras: ${formatOptions(META.extras.stacks)}`);               
      128 -        process.exit(1);                                      
      129 -      }                                                       
      130 -    }                                                         
      131 -    partial.extras = extrasList as (keyof typeof              
          -META.extras.stacks)[];                                        
      132 -  }                                                           
      133 -                                                              
      134 -  // Skip install (--no-install flag is parsed as install:    
          -false by Commander)                                           
      120    if (flags.install === false) {                              
      121      partial.skipInstall = true;                               
      122    }                                                           
      123                                                                
      124 -  // Validate context                                         
      124    validateContext(partial);                                   
      125                                                                
      126    return partial;                                             
     ...
      152    if (parts.length < 2 || parts.length > 3) {                 
      153      printError(                                               
      154        `Invalid app format '${appFlag}'`,                      
      155 -      'Expected format: name:stack or name:stack:module1,     
          -module2',                                                     
      155 +      'Expected format: name:stack or name:stack:addon1,addon2
          +',                                                            
      156        'Examples:',                                            
      157        '  --app web:nextjs',                                   
      158        '  --app web:nextjs:shadcn,mdx',                        
      159 -      '  --app mobile:expo:nativewind',                       
      159      );                                                        
      160      process.exit(1);                                          
      161    }                                                           
      162                                                                
      163 -  const [appName, stackName, modulesStr                       
          -] = parts as [string, string, string];                        
      163 +  const [appName, stackName, addonsStr                        
          +] = parts as [string, string, string | undefined];            
      164                                                                
      165 -  // Validate stack                                           
      166 -  if (!isValidKey(stackName, META.stacks)) {                  
      167 -    printError(`Invalid stack '${stackName}' for app          
          -'${appName}'`, `Available stacks: ${formatStackOptions()}`);  
      165 +  if (!META.stacks[stackName as StackName]) {                 
      166 +    printError(`Invalid stack '${stackName}' for app          
          +'${appName}'`, `Available stacks:                             
          +${Object.keys(META.stacks).join(', ')}`);                     
      167      process.exit(1);                                          
      168    }                                                           
      169                                                                
      170 -  const metaStack = META.stacks[stackName as StackName];      
      171 -  if (!metaStack) {                                           
      172 -    printError(`Invalid stack '${stackName}' for app          
          -'${appName}'`, `Available stacks: ${formatStackOptions()}`);  
      173 -    process.exit(1);                                          
      174 -  }                                                           
      175 -  const modules: string[] = modulesStr ?                      
          -modulesStr.split(',').map((m) => m.trim()) : [];              
      170 +  const addons: string[] = addonsStr ?                        
          +addonsStr.split(',').map((m) => m.trim()) : [];               
      171                                                                
      172 -  if (modules.length > 0) {                                   
      173 -    for (const moduleName of modules) {                       
      174 -      const mod = META.modules[moduleName];                   
      175 -      if (!mod) {                                             
      176 -        printError(`Invalid module '${moduleName}'`,          
          -`Available modules: ${Object.keys(META.modules).join(',       
          -')}`);                                                        
      177 -        process.exit(1);                                      
      178 -      }                                                       
      179 -      if (!isModuleCompatible(mod, stackName as StackName)) { 
      180 -        const compatibleStacks = mod.stacks === 'all' ? 'all' 
          - : (mod.stacks as string[]).join(', ');                       
      181 -        printError(                                           
      182 -          `Module '${moduleName}' is not compatible with      
          -stack '${stackName}'`,                                        
      183 -          `Compatible stacks: ${compatibleStacks}`,           
      184 -        );                                                    
      185 -        process.exit(1);                                      
      186 -      }                                                       
      172 +  for (const addonName of addons) {                           
      173 +    const addon = META.addons[addonName];                     
      174 +    if (!addon) {                                             
      175 +      printError(`Invalid addon '${addonName}'`, `Available   
          +addons: ${Object.keys(META.addons).join(', ')}`);             
      176 +      process.exit(1);                                        
      177      }                                                         
      178 +    if (addon.type !== 'module') {                            
      179 +      printError(`Addon '${addonName}' is not a module`, 'Use 
          + --addon flag for orm, database, and extras', `Example:       
          +--addon ${addonName}`);                                       
      180 +      process.exit(1);                                        
      181 +    }                                                         
      182 +    if (!isAddonCompatible(addon, stackName as StackName)) {  
      183 +      const compatibleStacks = addon.support?.stacks ===      
          +'all' ? 'all' : (addon.support?.stacks as string[])?.join(',  
          +') ?? 'none';                                                 
      184 +      printError(`Addon '${addonName}' is not compatible with 
          + stack '${stackName}'`, `Compatible stacks:                   
          +${compatibleStacks}`);                                        
      185 +      process.exit(1);                                        
      186 +    }                                                         
      187    }                                                           
      188                                                                
      189    return {                                                    
      190      appName: appName.trim(),                                  
      191      stackName: stackName as StackName,                        
      192 -    modules,                                                  
      192 +    addons,                                                   
      193    };                                                          
      194  }                                                             
      195                                                                
      196  function validateContext(partial: Partial<TemplateContext>):  
           void {                                                        
      197 -  // ORM requires database                                    
      198 -  if (partial.orm && !partial.database) {                     
      199 -    printError(                                               
      200 -      'ORM requires a database',                              
      201 -      'Add --database postgres or --database mysql',          
      202 -      `You selected: --orm ${partial.orm}`,                   
      203 -    );                                                        
      204 -    process.exit(1);                                          
      197 +  const globalAddons = partial.globalAddons ?? [];            
      198 +                                                              
      199 +  for (const addonName of globalAddons) {                     
      200 +    const addon = META.addons[addonName];                     
      201 +    if (addon && !areAddonDependenciesMet(addon,              
          +globalAddons)) {                                              
      202 +      const required = addon.support?.addons?.join(' or ') ?? 
          + '';                                                          
      203 +      printError(`Addon '${addonName}' requires one of:       
          +${required}`, `Add --addon ${addon.support?.addons?.[0] ??    
          +'postgres'}`);                                                
      204 +      process.exit(1);                                        
      205 +    }                                                         
      206    }                                                           
      207                                                                
      208 -  // Husky requires git                                       
      209 -  if (partial.extras?.includes('husky') && !partial.git) {    
      210 -    printError('Husky requires git to be initialized', 'Add   
          ---git flag', 'You selected: --extras husky');                 
      208 +  if (globalAddons.includes('husky') && !partial.git) {       
      209 +    printError('Husky requires git', 'Add --git flag');       
      210      process.exit(1);                                          
      211    }                                                           
      212                                                                
      213 -  // Validate app names are unique                            
      213    if (partial.apps && partial.apps.length > 1) {              
      214      const names = partial.apps.map((app) => app.appName);     
      215      const duplicates = names.filter((name, index) =>          
           names.indexOf(name) !== index);                               
     ...
      229    }                                                           
      230  }                                                             
      231                                                                
      232 -// Helper functions                                           
      233 -function isValidKey<T extends Record<string, unknown>>(key:   
          -string, obj: T): boolean {                                    
      234 -  return key in obj;                                          
      235 -}                                                             
      236 -                                                              
      237 -function formatOptions<T extends Record<string, { label:      
          -string; hint?: string }>>(stacks: T): string {                
      238 -  return Object.entries(stacks)                               
      239 -    .map(([key, meta]) => `${key} (${meta.hint ||             
          -meta.label})`)                                                
      240 -    .join(', ');                                              
      241 -}                                                             
      242 -                                                              
      243 -function formatStackOptions(): string {                       
      244 -  return Object.entries(META.stacks)                          
      245 -    .map(([key, meta]) => `${key} [${meta.type}]              
          -(${meta.hint})`)                                              
      246 -    .join(', ');                                              
      247 -}                                                             
      248 -                                                              
      232  function printError(title: string, ...messages: string[]):    
           void {                                                        
      233 -  console.error(`\n${color.red('                             
          -')} ${color.bold(color.red(title))}`);                        
      233 +  console.error(`\n${color.red('Ô£û                             
          +')} ${color.bold(color.red(title))}`);                        
      234    for (const msg of messages) {                               
      235      console.error(color.gray(msg));                           
      236    }                                                           

ÔùÅ Bash(git add apps/cli/src/flags.ts && git commit -m "refactor(flags): update
      for unified addon system with --addon flag")
  ÔÄ┐ ┬á[refactor/template-system f23f67a] refactor(flags): update for unified
     addon system with --addon flag
      1 file changed, 59 insertions(+), 114 deletions(-)
     ÔÇª +9 lines (ctrl+o to expand)

ÔùÅ Now Task 5.2: Update cli.ts and stack-prompts.ts. Let me read them:

ÔùÅ Read 2 files (ctrl+o to expand)

ÔùÅ Both files need to be updated. Let me rewrite them:

ÔùÅ Write(apps/cli/src/prompts/stack-prompts.ts)
  ÔÄ┐ ┬áAdded 90 lines, removed 15 lines
       1 +// ABOUTME: Custom prompts for stack and addon selection       
       2 +// ABOUTME: Groups addons by type for better UX                
       3 +                                                               
       4  import { isCancel, SelectPrompt } from '@clack/core';          
       5 -import { cancel, groupMultiselect,                             
         -type Option } from '@clack/prompts';                           
       5 +import { cancel, groupMultiselect, select,                     
         +type Option } from '@clack/prompts';                           
       6  import color from 'picocolors';                                
       7  import { META } from '@/__meta__';                             
       8  import { S_CONNECT_LEFT, S_GRAY_BAR, symbol } from             
          '@/tui/symbols';                                               
       9 -import { isModuleCompatible, type                              
         -StackName } from '@/types/meta';                               
       9 +import type { StackName } from '@/types/meta';                 
      10 +import { isAddonCompatible, getAddonsByType } from             
         +'@/lib/addon-utils';                                           
      11                                                                 
      12  export async function selectStackPrompt(message: string):      
          Promise<string> {                                              
      13    const SelectStackPrompt = new SelectPrompt({                 
      14      options: Object.entries(META.stacks)                       
      15 -      // Sort by type to group app stacks together and server  
         -stacks together                                                
      15        .sort(([, a], [, b]) => {                                
      16          if (a.type === b.type) return 0;                       
      17          return a.type === 'app' ? -1 : 1;                      
     ...
      50    return result;                                               
      51  }                                                              
      52                                                                 
      53 -export async function multiselectModulesPrompt(                
      54 -  stackName: StackName,                                        
      55 -  message: string,                                             
      56 -  required: boolean,                                           
      57 -): Promise<string[]> {                                         
      58 -  const compatibleModules =                                    
         -Object.entries(META.modules).filter(([, mod]) =>               
         -isModuleCompatible(mod, stackName));                           
      53 +export async function multiselectAddonsPrompt(stackName:       
         +StackName, message: string, required: boolean):                
         +Promise<string[]> {                                            
      54 +  const addonGroups = getAddonsByType(META);                   
      55 +  const moduleAddons = addonGroups.module ?? [];               
      56                                                                 
      57 -  if (compatibleModules.length === 0) {                        
      57 +  const compatibleAddons = moduleAddons.filter((addonName) =>  
         +{                                                              
      58 +    const addon = META.addons[addonName];                      
      59 +    return addon && isAddonCompatible(addon, stackName);       
      60 +  });                                                          
      61 +                                                               
      62 +  if (compatibleAddons.length === 0) {                         
      63      return [];                                                 
      64    }                                                            
      65                                                                 
      66    const groupedOptions: Record<string, Option<string>[]> = {   
      67 -    Modules: compatibleModules.map(([moduleName, meta]) => ({  
      68 -      value: moduleName,                                       
      69 -      label: meta.label,                                       
      70 -      hint: meta.hint,                                         
      71 -    })),                                                       
      67 +    Modules: compatibleAddons.map((addonName) => {             
      68 +      const addon = META.addons[addonName];                    
      69 +      return {                                                 
      70 +        value: addonName,                                      
      71 +        label: addon.label,                                    
      72 +        hint: addon.hint,                                      
      73 +      };                                                       
      74 +    }),                                                        
      75    };                                                           
      76                                                                 
      77    const result = await groupMultiselect({                      
     ...
       83                                                                
       84    return result;                                              
       85  }                                                             
       86 +                                                              
       87 +export async function selectGlobalAddonPrompt(type: 'orm' |   
          +'database', message: string): Promise<string | undefined> {   
       88 +  const addonGroups = getAddonsByType(META);                  
       89 +  const addons = addonGroups[type] ?? [];                     
       90 +                                                              
       91 +  if (addons.length === 0) {                                  
       92 +    return undefined;                                         
       93 +  }                                                           
       94 +                                                              
       95 +  const options: { value: string | undefined; label: string;  
          +hint?: string }[] = [                                         
       96 +    { value: undefined, label: 'None', hint: 'Skip this       
          +option' },                                                    
       97 +    ...addons.map((addonName) => {                            
       98 +      const addon = META.addons[addonName];                   
       99 +      return {                                                
      100 +        value: addonName,                                     
      101 +        label: addon.label,                                   
      102 +        hint: addon.hint,                                     
      103 +      };                                                      
      104 +    }),                                                       
      105 +  ];                                                          
      106 +                                                              
      107 +  const result = await select({                               
      108 +    message,                                                  
      109 +    options,                                                  
      110 +  });                                                         
      111 +                                                              
      112 +  if (isCancel(result)) {                                     
      113 +    cancel('­ƒæï Bye');                                         
      114 +    process.exit(0);                                          
      115 +  }                                                           
      116 +                                                              
      117 +  return result;                                              
      118 +}                                                             
      119 +                                                              
      120 +export async function multiselectGlobalAddonsPrompt(type:     
          +'extra', message: string, required: boolean):                 
          +Promise<string[]> {                                           
      121 +  const addonGroups = getAddonsByType(META);                  
      122 +  const addons = addonGroups[type] ?? [];                     
      123 +                                                              
      124 +  if (addons.length === 0) {                                  
      125 +    return [];                                                
      126 +  }                                                           
      127 +                                                              
      128 +  const groupedOptions: Record<string, Option<string>[]> = {  
      129 +    [type.charAt(0).toUpperCase() + type.slice(1)]:           
          +addons.map((addonName) => {                                   
      130 +      const addon = META.addons[addonName];                   
      131 +      return {                                                
      132 +        value: addonName,                                     
      133 +        label: addon.label,                                   
      134 +        hint: addon.hint,                                     
      135 +      };                                                      
      136 +    }),                                                       
      137 +  };                                                          
      138 +                                                              
      139 +  const result = await groupMultiselect({                     
      140 +    options: groupedOptions,                                  
      141 +    message,                                                  
      142 +    required,                                                 
      143 +    selectableGroups: false,                                  
      144 +  });                                                         
      145 +                                                              
      146 +  if (isCancel(result)) {                                     
      147 +    cancel('­ƒæï Bye');                                         
      148 +    process.exit(0);                                          
      149 +  }                                                           
      150 +                                                              
      151 +  return result;                                              
      152 +}                                                             

ÔùÅ Now update cli.ts:

ÔùÅ Write(apps/cli/src/cli.ts)
  ÔÄ┐ ┬áAdded 54 lines, removed 67 lines
       1 +// ABOUTME: Main CLI flow with interactive prompts             
       2 +// ABOUTME: Collects project config and returns                
         +TemplateContext                                                
       3 +                                                               
       4  import { existsSync } from 'node:fs';                          
       5  import { join } from 'node:path';                              
       6  import { cancel, log } from '@clack/prompts';                  
       7  import color from 'picocolors';                                
       8  import { META } from '@/__meta__';                             
       9 -import { promptConfirm, promptMultiselect,                     
         -promptSelect, promptText } from '@/prompts/base-prompts';      
      10 -import { multiselectModulesPrompt, selectStackPrompt } from    
         -'@/prompts/stack-prompts';                                     
       9 +import { promptConfirm,                                        
         +promptSelect, promptText } from '@/prompts/base-prompts';      
      10 +import { multiselectAddonsPrompt, selectGlobalAddonPrompt,     
         +multiselectGlobalAddonsPrompt, selectStackPrompt } from        
         +'@/prompts/stack-prompts';                                     
      11  import { Progress } from '@/tui/progress';                     
      12  import type { AppContext, TemplateContext } from               
          '@/types/ctx';                                                 
      13 -import type { DatabaseName, ExtraName, OrmName,                
         -StackName } from '@/types/meta';                               
      13 +import type { StackName } from '@/types/meta';                 
      14 +import { areAddonDependenciesMet } from '@/lib/addon-utils';   
      15  import { S_GRAY_BAR } from './tui/symbols';                    
      16                                                                 
      17  export async function cli(partial?: Partial<TemplateContext>): 
           Promise<Omit<TemplateContext, 'repo'>> {                      
     ...
      16    const ctx: Omit<TemplateContext, 'repo'> = {                 
      17      projectName: '',                                           
      18      apps: [],                                                  
      19 +    globalAddons: [],                                          
      20      git: false,                                                
      21    };                                                           
      22                                                                 
      23    if (partial?.projectName) {                                  
      24      ctx.projectName = partial.projectName;                     
      25 -    log.info(`${color.green('Ô£ô')} Using project name from flags
         -: ${color.bold(partial.projectName)}`);                        
      26 -    // Validate path doesn't exist                             
      25 +    log.info(`${color.green('Ô£ô')} Using project name           
         +: ${color.bold(partial.projectName)}`);                        
      26      const fullPath = join(process.cwd(), partial.projectName); 
      27      if (existsSync(fullPath)) {                                
      28 -      cancel(`A file or directory named                        
         -"${partial.projectName}" already exists.                       
         - Please choose a different name.`);                            
      28 +      cancel(`Directory                                        
         +"${partial.projectName}" already exists.`);                    
      29        process.exit(1);                                         
      30      }                                                          
      31    } else {                                                     
     ...
      33        placeholder: 'my-app',                                   
      34        initialValue: 'my-app',                                  
      35        validate: (value) => {                                   
      36 -        const trimedValue = value.trim();                      
      37 -        if (!value || trimedValue === ''                       
         -) return 'Project name is required';                           
      38 -        const fullPath = join(process.cwd(), trimedValue);     
      39 -        try {                                                  
      40 -          if (existsSync(fullPath)) {                          
      41 -            return `A file or directory named "${trimedValue}" 
         - already exists. Please choose a different name.`;             
      42 -          }                                                    
      43 -        } catch (e) {                                          
      44 -          return `An error occurred while checking if the app  
         -name is valid: ${(e as Error).message}`;                       
      36 +        const trimmed = value.trim();                          
      37 +        if (!trimmed) return 'Project name is required';       
      38 +        const fullPath = join(process.cwd(), trimmed);         
      39 +        if (existsSync(fullPath)) {                            
      40 +          return `Directory "${trimmed}" already exists.`;     
      41          }                                                      
      42        },                                                       
      43      });                                                        
     ...
      50                                                                 
      51    if (partial?.apps && partial.apps.length > 0) {              
      52      ctx.apps = partial.apps;                                   
      53 -    log.info(                                                  
      54 -      `${color.green('Ô£ô')} Using ${partial.apps.length} app(s) 
         - from flags: ${partial.apps.map((a) => a.appName).join(',      
         -')}`,                                                          
      55 -    );                                                         
      53 +    log.info(`${color.green('Ô£ô')} Using ${partial.apps.length} 
         + app(s): ${partial.apps.map((a) => a.appName).join(', ')}`);   
      54    } else {                                                     
      55      const appCount = await promptText<number>(                 
      56 -      `${progress.message('How many apps do you want to create 
         -?')}                                                           
      57 -${S_GRAY_BAR}  ${color.italic(color.gray('Eg: a                
         -backend + a frontend = enter 2'))}                             
      58 -${S_GRAY_BAR}  ${color.italic(color.gray('Only a Next.js app = 
         - enter 1'))}                                                   
      59 -${S_GRAY_BAR}  ${color.italic(color.gray('Turborepo will be    
         -used if more than one'))}`,                                    
      56 +      `${progress.message('How many apps?')}                   
      57 +${S_GRAY_BAR}  ${color.italic(color.gray('Multiple apps =      
         +Turborepo monorepo'))}`,                                       
      58        {                                                        
      59          initialValue: '1',                                     
      60          placeholder: 'Enter a number',                         
     ...
       73    }                                                           
       74    progress.next();                                            
       75                                                                
       76 -  if (partial?.database !== undefined) {                      
       77 -    ctx.database = partial.database ?? undefined;             
       78 -    if (partial.database) {                                   
       79 -      log.info(`${color.green('Ô£ô')} Using database from flags 
          -: ${color.bold(partial.database)}`);                          
       80 -    } else if (partial.database === null) {                   
       81 -      log.info(`${color.green('Ô£ô')} Skipping database         
          -setup`);                                                      
       76 +  if (partial?.globalAddons !== undefined) {                  
       77 +    ctx.globalAddons = partial.globalAddons;                  
       78 +    if (partial.globalAddons.length > 0) {                    
       79 +      log.info(`${color.green('Ô£ô')} Using addons: ${partial.  
          +globalAddons.join(', ')}`);                                   
       80      }                                                         
       81    } else {                                                    
       82 -    ctx.database = (await promptSelect                        
          -('database', progress.message(`Include a                      
          -${color.bold('database')}?`), ctx, {                          
       83 -      allowNone: true,                                        
       84 -    })) as DatabaseName | undefined;                          
       85 -  }                                                           
       82 +    const database = await selectGlobalAddonPrompt            
          +('database', progress.message(`Include a                      
          +${color.bold('database')}?`));                                
       83 +    if (database) {                                           
       84 +      ctx.globalAddons.push(database);                        
       85 +    }                                                         
       86                                                                
       87 -  if (partial?.orm !== undefined) {                           
       88 -    ctx.orm = partial.orm ?? undefined;                       
       89 -    if (partial.orm) {                                        
       90 -      log.info(`${color.green('Ô£ô')} Using ORM from flags:     
          -${color.bold(partial.orm)}`);                                 
       91 -    } else if (partial.orm === null) {                        
       92 -      log.info(`${color.green('Ô£ô')} Skipping ORM setup`);     
       87 +    if (database) {                                           
       88 +      const orm = await selectGlobalAddonPrompt('orm',        
          +progress.message(`Configure an ${color.bold('ORM')}?`));      
       89 +                                                              
       90 +      if (orm) {                                              
       91 +        const ormAddon = META.addons[orm];                    
       92 +        if (ormAddon && !areAddonDependenciesMet(ormAddon,    
          +ctx.globalAddons)) {                                          
       93 +          log.warn(`${orm} requires a database. Skipping.`);  
       94 +        } else {                                              
       95 +          ctx.globalAddons.push(orm);                         
       96 +        }                                                     
       97 +      }                                                       
       98      }                                                         
       99 -  } else {                                                    
      100 -    ctx.orm = (await promptSelect('orm',                      
          -progress.message(`Configure an ${color.bold('ORM')}?`), ctx,  
          -{                                                             
      101 -      allowNone: true,                                        
      102 -    })) as OrmName | undefined;                               
       99    }                                                           
      100 -                                                              
      100    progress.next();                                            
      101                                                                
      102    if (partial?.git !== undefined) {                           
      103      ctx.git = partial.git;                                    
      104      if (partial.git) {                                        
      105 -      log.info(`${color.green('Ô£ô')} Git initialization enabled
          - from flags`);                                                
      105 +      log.info(`${color.green('Ô£ô')} Git initialization enabled
          +`);                                                           
      106      }                                                         
      107    } else {                                                    
      108      ctx.git = await                                           
           promptConfirm(progress.message(`Initialize                    
           ${color.bold('Git')}?`), {                                    
     ...
      112      });                                                       
      113    }                                                           
      114                                                                
      115 -  if (partial?.extras !== undefined) {                        
      116 -    ctx.extras = partial.extras;                              
      117 -    if (partial.extras && partial.extras.length > 0) {        
      118 -      log.info(`${color.green('Ô£ô')} Using extras from flags:  
          -${partial.extras.join(', ')}`);                               
      115 +  if (partial?.globalAddons === undefined) {                  
      116 +    const extras = await                                      
          +multiselectGlobalAddonsPrompt('extra', progress.message(`Add  
          +any ${color.bold('extras')}?`), false);                       
      117 +                                                              
      118 +    for (const extra of extras) {                             
      119 +      if (extra === 'husky' && !ctx.git) {                    
      120 +        log.warn('Husky requires git. Skipping.');            
      121 +        continue;                                             
      122 +      }                                                       
      123 +      ctx.globalAddons.push(extra);                           
      124      }                                                         
      125 -  } else {                                                    
      126 -    ctx.extras = (await promptMultiselect('extras',           
          -progress.message(`Add any ${color.bold('extras')}?`), ctx, {  
      127 -      required: false,                                        
      128 -    })) as ExtraName[] | undefined;                           
      125    }                                                           
      126 -                                                              
      126    progress.next();                                            
      127                                                                
      128    if (partial?.skipInstall) {                                 
     ...
      130      log.info(`${color.green('Ô£ô')} Skipping dependency         
           installation`);                                               
      131    } else if (partial?.pm !== undefined) {                     
      132      ctx.pm = partial.pm;                                      
      133 -    if (partial.pm) {                                         
      134 -      log.info(`${color.green('Ô£ô')} Using package manager     
          -from flags: ${color.bold(partial.pm)}`);                      
      135 -    }                                                         
      133 +    log.info(`${color.green('Ô£ô')} Using package manager:      
          +${color.bold(partial.pm)}`);                                  
      134    } else {                                                    
      135      ctx.pm = await promptSelect(undefined,                    
           progress.message(`Install dependencies                        
           ${color.bold('now')}?`), ctx, {                               
      136        options: [                                              
     ...
      143        ],                                                      
      144      });                                                       
      145    }                                                           
      146 -                                                              
      146    progress.next();                                            
      147                                                                
      148    return ctx;                                                 
     ...
      169    if (projectNameIfOneApp) {                                  
      170      appName = projectNameIfOneApp;                            
      171    } else {                                                    
      172 -    appName = await promptText<string>(progress.message(`Name 
          -of the app ${color.bold(`#${index}`)}?`), {                   
      172 +    appName = await promptText<string>(progress.message(`Name 
          +of app ${color.bold(`#${index}`)}?`), {                       
      173        defaultValue: `app-${index}`,                           
      174        placeholder: `app-${index}`,                            
      175        validate: (value) => {                                  
      176 -        const trimedValue = value.trim();                     
      177 -        if (!value || trimedValue === '') return 'App name is 
          - required';                                                   
      176 +        if (!value.trim()) return 'App name is required';     
      177        },                                                      
      178      });                                                       
      179    }                                                           
      180                                                                
      181 -  const stackName = (await selectStackPrompt(                 
      182 -    progress.message(`Select the stack for                    
          -${color.bold(appName)}`),                                     
      183 -  )) as StackName;                                            
      181 +  const stackName = (await                                    
          +selectStackPrompt(progress.message(`Stack for                 
          +${color.bold(appName)}`))) as StackName;                      
      182                                                                
      183    const metaStack = META.stacks[stackName];                   
      184 -                                                              
      184    if (!metaStack) {                                           
      185      cancel(`Stack "${stackName}" not found`);                 
      186      process.exit(0);                                          
      187    }                                                           
      188                                                                
      189 -  const modules = await multiselectModulesPrompt(             
      189 +  const addons = await multiselectAddonsPrompt(               
      190      stackName,                                                
      191 -    progress.message(`Do you want to add any                  
          -${color.bold(metaStack.label)} modules to                     
          -${color.bold(appName)}?`),                                    
      191 +    progress.message(`Add                                     
          +${color.bold(metaStack.label)} modules to                     
          +${color.bold(appName)}?`),                                    
      192      false,                                                    
      193    );                                                          
      194                                                                
      195 -  return { appName, stackName, modules };                     
      195 +  return { appName, stackName, addons };                      
      196  }                                                             

ÔùÅ Now I need to check if there are any other files that still reference the old
  context structure. Let me check for usages of modules, orm, database, extras:

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli && grep -r
      "ctx\.modules\|ctx\.orm\|ctx\.database\|ctx\.extras\|META\.modules\|META\.
      orm\|META\.database\|META\.extrÔÇª)
  ÔÄ┐ ┬ásrc/tui/summary.ts:  if (ctx.database) {
     src/tui/summary.ts:    flagsCommand += ` --database ${ctx.database}`;
     src/tui/summary.ts:  if (ctx.orm) {
     ÔÇª +15 lines (ctrl+o to expand)

ÔùÅ I need to update tui/summary.ts:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ Write(apps/cli/src/tui/summary.ts)
  ÔÄ┐ ┬áAdded 24 lines, removed 25 lines
      1 +// ABOUTME: Summary display and CLI command generation          
      2 +// ABOUTME: Shows project structure and recreate command with   
        +unified addons                                                  
      3 +                                                                
      4  import { note, outro } from '@clack/prompts';                   
      5  import color from 'picocolors';                                 
      6  import { META } from '@/__meta__';                              
     ...
       7    let flagsCommand: string = `bunx create-faster               
          ${ctx.projectName}`;                                           
       8                                                                 
       9    for (const app of ctx.apps) {                                
      10 -    const modulesStr = app.modules.length > 0 ? `:${app.modules
         -.join(',')}` : '';                                             
      11 -    flagsCommand += ` --app ${app.appName}:${app.stackName}${  
         -modulesStr}`;                                                  
      10 +    const addonsStr = app.addons.length > 0 ? `:${app.addons   
         +.join(',')}` : '';                                             
      11 +    flagsCommand += ` --app ${app.appName}:${app.stackName}${  
         +addonsStr}`;                                                   
      12    }                                                            
      13                                                                 
      14 -  if (ctx.database) {                                          
      15 -    flagsCommand += ` --database ${ctx.database}`;             
      14 +  for (const addonName of ctx.globalAddons) {                  
      15 +    flagsCommand += ` --addon ${addonName}`;                   
      16    }                                                            
      17                                                                 
      18 -  if (ctx.orm) {                                               
      19 -    flagsCommand += ` --orm ${ctx.orm}`;                       
      20 -  }                                                            
      21 -                                                               
      18    if (ctx.git) {                                               
      19      flagsCommand += ' --git';                                  
      20    }                                                            
     ...
      27      flagsCommand += ` --pm ${ctx.pm}`;                         
      28    }                                                            
      29                                                                 
      30 -  if (ctx.extras && ctx.extras.length > 0) {                   
      31 -    flagsCommand += ` --extras ${ctx.extras.join(',')}`;       
      32 -  }                                                            
      33 -                                                               
      30    if (flagsCommand.length > 140) {                             
      31      flagsCommand = flagsCommand.replaceAll('--', '\\\n  --');  
      32    }                                                            
      33                                                                 
      34    outro(`${color.bgCyan(color.black(`­ƒÜÇ Project created        
          successfully at ${projectPath}!`))}                            
      35 -                                                               
      35 +                                                               
      36  ${color.gray('­ƒöÑ You can recreate this project with the        
          following command:')}                                          
      37                                                                 
      38  ${color.bold(flagsCommand)}`);                                 
     ...
      52    const lines: string[] = [];                                  
      53    const isTurborepo = ctx.repo === 'turborepo';                
      54                                                                 
      55 +  const hasOrm = ctx.globalAddons.some((name) =>               
         +META.addons[name]?.type === 'orm');                            
      56 +  const hasDb = ctx.globalAddons.some((name) =>                
         +META.addons[name]?.type === 'database');                       
      57 +                                                               
      58    lines.push(color.white(color.bold('#­ƒÅá Structure:')));       
      59    lines.push('');                                              
      60                                                                 
     ...
      61      lines.push('Ôö£ÔöÇ ­ƒÜÇ apps/');                                 
      62      ctx.apps.forEach((app, i) => {                             
      63        const stack = META.stacks[app.stackName];                
      64 -      const modulesInfo = app.modules                          
         -.length > 0 ? color.dim(` +${app.modules                       
         -.length} modules`) : '';                                       
      65 -      const isLast = i === ctx.apps.length - 1 && !ctx.orm;    
      64 +      const addonsInfo = app.addons                            
         +.length > 0 ? color.dim(` +${app.addons.length} modules`) : '';
      65 +      const isLast = i === ctx.apps.length - 1 && !hasOrm;     
      66        const prefix = isLast ? 'Ôöé  ÔööÔöÇ' : 'Ôöé  Ôö£ÔöÇ';               
      67 -      lines.push(`${prefix} ${app.appName}/                    
         -${color.yellow(`(${stack?.label}${modulesInfo})`)}`);          
      67 +      lines.push(`${prefix} ${app.appName}/                    
         +${color.yellow(`(${stack?.label}${addonsInfo})`)}`);           
      68      });                                                        
      69    } else {                                                     
      70      const app = ctx.apps[0];                                   
      71      if (app) {                                                 
      72        const stack = META.stacks[app.stackName];                
      73 -      const modulesInfo = app.modules                          
         -.length > 0 ? color.dim(` +${app.modules                       
         -.length} modules`) : '';                                       
      74 -      lines.push(`Ôö£ÔöÇ ­ƒôü src/ ${color.yellow(`(${stack?.label}${
         -modulesInfo})`)}`);                                            
      73 +      const addonsInfo = app.addons                            
         +.length > 0 ? color.dim(` +${app.addons.length} modules`) : '';
      74 +      lines.push(`Ôö£ÔöÇ ­ƒôü src/ ${color.yellow(`(${stack?.label}${
         +addonsInfo})`)}`);                                             
      75      }                                                          
      76    }                                                            
      77                                                                 
      78 -  if (isTurborepo && ctx.orm) {                                
      78 +  if (isTurborepo && hasOrm) {                                 
      79      lines.push('Ôö£ÔöÇ ­ƒôª packages/');                             
      80 -    const ormMeta = ctx.orm ? META.orm.stacks[ctx.orm] : null; 
      81 -    const dbMeta = ctx.database ?                              
         -META.database.stacks[ctx.database] : null;                     
      82 -    const dbInfo = dbMeta ? ` + ${dbMeta.label}` : '';         
      83 -    lines.push(`Ôöé  ÔööÔöÇ db/                                      
         -${color.magenta(`(${ormMeta?.label}${dbInfo})`)}`);            
      80 +    const ormAddon = ctx.globalAddons.find((name) =>           
         +META.addons[name]?.type === 'orm');                            
      81 +    const dbAddon = ctx.globalAddons.find((name) =>            
         +META.addons[name]?.type === 'database');                       
      82 +    const ormLabel = ormAddon ? META.addons[ormAddon]?.label : 
         + '';                                                           
      83 +    const dbLabel = dbAddon ? ` +                              
         +${META.addons[dbAddon]?.label}` : '';                          
      84 +    lines.push(`Ôöé  ÔööÔöÇ db/                                      
         +${color.magenta(`(${ormLabel}${dbLabel})`)}`);                 
      85    }                                                            
      86                                                                 
      87    const configs: string[] = [];                                
      88    if (isTurborepo) configs.push('Turborepo');                  
      89    if (ctx.git) configs.push('Git');                            
      90 -  if (ctx.extras?.includes('biome')) configs.push('Biome');    
      91 -  if (ctx.extras?.includes('husky')) configs.push('Husky');    
      90 +  if (ctx.globalAddons                                         
         +.includes('biome')) configs.push('Biome');                     
      91 +  if (ctx.globalAddons                                         
         +.includes('husky')) configs.push('Husky');                     
      92                                                                 
      93    if (configs.length > 0) {                                    
      94      lines.push(`ÔööÔöÇ ÔÜÖ´©Å  ${color.dim(configs.join(', '))}`);     

ÔùÅ Let me check for any other files that might have old references:

ÔùÅ Searched for 1 pattern (ctrl+o to expand)

ÔùÅ Let me check the base-prompts.ts file as it's imported by cli.ts:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ This file uses Category from types/meta.ts which was removed. However, the
  cli.ts I updated no longer uses promptMultiselect with a category. Let me
  check what functions are actually being used now:

ÔùÅ Searched for 2 patterns (ctrl+o to expand)

ÔùÅ The cli.ts now only uses promptSelect with undefined as the category, which
  means the base-prompts.ts file can be simplified. Let me simplify it to remove
   the Category dependency:

ÔùÅ Write(apps/cli/src/prompts/base-prompts.ts)
  ÔÄ┐ ┬áAdded 8 lines, removed 80 lines
       1 -// ABOUTME: Base prompt wrappers with context-aware filtering  
       2 -// ABOUTME: Provides type-safe prompt functions                
         - with cancellation handling                                    
       1 +// ABOUTME: Base prompt wrappers with cancellation handling    
       2 +// ABOUTME: Provides type-safe prompt functions                
       3                                                                 
       4  import {                                                       
       5    type ConfirmOptions,                                         
       6    cancel,                                                      
       7    confirm,                                                     
       8    isCancel,                                                    
       9 -  log,                                                         
      10 -  type MultiSelectOptions,                                     
      11 -  multiselect,                                                 
      12 -  type Option,                                                 
       9    type SelectOptions,                                          
      10    select,                                                      
      11    type TextOptions,                                            
      12    text,                                                        
      13  } from '@clack/prompts';                                       
      14 -import { META } from '@/__meta__';                             
      14  import type { TemplateContext } from '@/types/ctx';            
      15 -import type { Category } from '@/types/meta';                  
      15                                                                 
      16 -interface StackMeta {                                          
      17 -  label: string;                                               
      18 -  hint?: string;                                               
      19 -  requires?: string[];                                         
      20 -}                                                              
      21 -                                                               
      22 -function filterOptionsByContext<C extends Category>(           
      23 -  category: C,                                                 
      24 -  ctx: Partial<TemplateContext>,                               
      25 -): Option<string | undefined>[] {                              
      26 -  const categoryMeta = META[category] as { requires?:          
         -string[]; stacks: Record<string, StackMeta> };                 
      27 -                                                               
      28 -  if (categoryMeta.requires) {                                 
      29 -    const isRequired = categoryMeta.requires.every(            
      30 -      (required: string) => required in ctx && Boolean((ctx as 
         - Record<string, unknown>)[required]),                          
      31 -    );                                                         
      32 -    if (!isRequired) {                                         
      33 -      log.info(`${category} skipped (requires:                 
         -${categoryMeta.requires.join(', ')})`);                        
      34 -      return [];                                               
      35 -    }                                                          
      36 -  }                                                            
      37 -                                                               
      38 -  return Object.entries(categoryMeta.stacks)                   
      39 -    .filter(([_value, meta]) => {                              
      40 -      if (!meta.requires) return true;                         
      41 -      const isRequired = meta.requires.every(                  
      42 -        (required: string) => required in ctx && Boolean((ctx  
         -as Record<string, unknown>)[required]),                        
      43 -      );                                                       
      44 -      if (!isRequired) {                                       
      45 -        log.info(`${meta.label} skipped because it requires    
         -${meta.requires.join(', ')}`);                                 
      46 -        return false;                                          
      47 -      }                                                        
      48 -      return isRequired;                                       
      49 -    })                                                         
      50 -    .map(([value, meta]) => ({ value, label: meta.label, hint: 
         - meta.hint }));                                                
      51 -}                                                              
      52 -                                                               
      53 -export async function promptText<T extends string | number =   
         -string>(                                                       
      54 -  message: string,                                             
      55 -  options?: Partial<TextOptions>,                              
      56 -): Promise<T> {                                                
      16 +export async function promptText<T extends string | number =   
         +string>(message: string, options?: Partial<TextOptions>):      
         +Promise<T> {                                                   
      17    const result = await text({ message, ...options });          
      18                                                                 
      19    if (isCancel(result)) {                                      
     ...
      70    return result as T;                                          
      71  }                                                              
      72                                                                 
      73 -export async function promptSelect<                            
         -C extends Category | undefined, R extends string | undefined>( 
      74 -  category: C,                                                 
      73 +export async function promptSelect<                            
         +R extends string | undefined>(                                 
      74 +  _category: undefined,                                        
      75    message: string,                                             
      76 -  ctx: Partial<TemplateContext>,                               
      77 -  options?: { allowNone?: boolean } &                          
         -Partial<SelectOptions<string | undefined>>,                    
      76 +  _ctx: Partial<TemplateContext>,                              
      77 +  options?: Partial<SelectOptions<string | undefined>>,        
      78  ): Promise<R> {                                                
      79 -  const selectOptions =                                        
         -category ? filterOptionsByContext(category, ctx) : (           
         -options?.options ?? []);                                       
      79 +  const selectOptions = options?.options ?? [];                
      80                                                                 
      81    if (selectOptions?.length === 0) {                           
      82      return undefined as R;                                     
      83    }                                                            
      84                                                                 
      85 -  if (options?.allowNone) {                                    
      86 -    selectOptions.push({ value: undefined, label: 'None' });   
      87 -  }                                                            
      88 -                                                               
      85    const result = await select({                                
      86      message,                                                   
      87      options: selectOptions,                                    
     ...
      101    return result as R;                                         
      102  }                                                             
      103                                                                
      104 -export async function promptMultiselect<C extends Category>(  
      105 -  category: C,                                                
      106 -  message: string,                                            
      107 -  ctx: Partial<TemplateContext>,                              
      108 -  options?: Partial<MultiSelectOptions<string>>,              
      109 -): Promise<string[] | undefined> {                            
      110 -  const selectOptions = filterOptionsByContext(category,      
          -ctx);                                                         
      111 -                                                              
      112 -  if (selectOptions.length === 0) {                           
      113 -    return undefined;                                         
      114 -  }                                                           
      115 -                                                              
      116 -  const result = await multiselect({ message, options:        
          -selectOptions, required: false, ...options });                
      117 -                                                              
      118 -  if (isCancel(result)) {                                     
      119 -    cancel('­ƒæï Bye');                                         
      120 -    process.exit(0);                                          
      121 -  }                                                           
      122 -                                                              
      123 -  return result as string[] | undefined;                      
      124 -}                                                             
      125 -                                                              
      104  export async function promptConfirm(message: string,          
           options?: Partial<ConfirmOptions>): Promise<boolean> {        
      105    const result = await confirm({ message, ...options });      
      106                                                                

ÔùÅ Now let me check for remaining issues in index.ts:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ This looks fine - it uses the config from cli which now returns the new
  structure. Let me check file-generator.ts and handlebars-utils.ts:

ÔùÅ Searched for 2 patterns, read 3 files (ctrl+o to expand)

ÔùÅ This file references this.modules, this.database, this.orm, this.extras which
  no longer exist in the new context structure. I need to update it for the
  unified addon system:

ÔùÅ Write(apps/cli/src/lib/handlebars.ts)
  ÔÄ┐ ┬áAdded 26 lines, removed 9 lines
      1  // ABOUTME: Handlebars template engine setup with custom        
         helpers                                                         
      2 -// ABOUTME: Provides core helpers for template rendering        
      2 +// ABOUTME: Provides core helpers for template rendering        
        + with unified addons                                            
      3                                                                  
      4  import Handlebars from 'handlebars';                            
      5 +import { META } from '@/__meta__';                              
      6  import type { AppContext, EnrichedTemplateContext,              
         TemplateContext } from '@/types/ctx';                           
      7 -import type { ExtraName } from '@/types/meta';                  
      7                                                                  
      8  export function registerHandlebarsHelpers(): void {             
      9    Handlebars.registerHelper('eq', (a: unknown, b: unknown) => a 
          === b);                                                        
     ...
      17    Handlebars.registerHelper('has', function (this:             
          EnrichedTemplateContext, category: string, value: string) {    
      18      switch (category) {                                        
      19        case 'module':                                           
      20 -        return Array.isArray(this.modules) && this.modules     
         -.includes(value);                                              
      20 +        return Array.isArray(this.addons) && this.addons       
         +.includes(value);                                              
      21        case 'database':                                         
      22 -        return this.database === value;                        
      22 +        return Array.isArray(this.globalAddons) &&             
         +this.globalAddons.includes(value);                             
      23        case 'orm':                                              
      24 -        return this.orm === value;                             
      24 +        return Array.isArray(this.globalAddons) &&             
         +this.globalAddons.includes(value);                             
      25        case 'extra':                                            
      26 -        return Array.isArray(this.extras) && this.extras       
         -.includes(value as ExtraName);                                 
      26 +        return Array.isArray(this.globalAddons) && this.       
         +globalAddons.includes(value);                                  
      27 +      case 'addon':                                            
      28 +        return (                                               
      29 +          (Array.isArray(this.addons) &&                       
         +this.addons.includes(value)) ||                                
      30 +          (Array.isArray(this.globalAddons) &&                 
         +this.globalAddons.includes(value))                             
      31 +        );                                                     
      32        case 'stack':                                            
      33          return Array.isArray(this.apps) &&                     
          this.apps.some((app) => app.stackName === value);              
      34        default:                                                 
     ...
      31      }                                                          
      32    });                                                          
      33                                                                 
      34 +  Handlebars.registerHelper('hasAddon', function (this:        
         +EnrichedTemplateContext, addonName: string) {                  
      35 +    return (                                                   
      36 +      (Array.isArray(this.addons) &&                           
         +this.addons.includes(addonName)) ||                            
      37 +      (Array.isArray(this.globalAddons) &&                     
         +this.globalAddons.includes(addonName))                         
      38 +    );                                                         
      39 +  });                                                          
      40 +                                                               
      41 +  Handlebars.registerHelper('hasAddonType', function (this:    
         +EnrichedTemplateContext, addonType: string) {                  
      42 +    const allAddons = [...(this.addons ?? []),                 
         +...(this.globalAddons ?? [])];                                 
      43 +    return allAddons.some((name) => META.addons[name]?.type    
         +=== addonType);                                                
      44 +  });                                                          
      45 +                                                               
      46    Handlebars.registerHelper('hasContext', function (this:      
          TemplateContext, contextName: keyof TemplateContext) {         
      47      return contextName in this && this[contextName] !==        
          undefined;                                                     
      48    });                                                          
     ...
      42    });                                                          
      43                                                                 
      44    Handlebars.registerHelper('databaseUrl', function (this:     
          TemplateContext) {                                             
      45 -    if (this.database === 'postgres') {                        
      45 +    if (this.globalAddons?.includes('postgres')) {             
      46        return `postgresql://postgres:password@localhost:5432/po 
          stgres-${this.projectName}`;                                   
      47 -    } else if (this.database === 'mysql') {                    
      47 +    } else if (this.globalAddons?.includes('mysql')) {         
      48        return `mysql://mysql:password@localhost:3306/mysql-${th 
          is.projectName}`;                                              
      49      }                                                          
      50      return null;                                               
     ...
      55    try {                                                        
      56      const template = Handlebars.compile(templateContent, {     
      57        noEscape: true,                                          
      58 -      strict: false, // Changed from true to handle missing    
         -properties gracefully                                          
      58 +      strict: false,                                           
      59        preventIndent: false,                                    
      60      });                                                        
      61                                                                 

ÔùÅ Now let me run all the tests that exist to check for issues:

ÔùÅ Bash(bun test 2>&1 | tail -50)
  ÔÄ┐       at <anonymous> (/home/ttecim/.lab/create-faster/apps/cli/tests/ha
    ndlebars.test.ts:90:44)
    (fail) Handlebars helpers > has > checks orm value [1.07ms]
    ÔÇª +57 lines (ctrl+o to expand)


ÔùÅ I need to update the handlebars tests. Let me check them:

ÔùÅ Read 1 file (ctrl+o to expand)

ÔùÅ I need to update these tests to use the new context structure:

ÔùÅ Write(apps/cli/tests/handlebars.test.ts)
  ÔÄ┐ ┬áAdded 45 lines, removed 21 lines
      1  // ABOUTME: Unit tests for Handlebars helpers                   
      2 -// ABOUTME: Tests the 6 simplified helpers: eq, ne, and, or,    
        -isTurborepo, has                                                
      2 +// ABOUTME: Tests helpers for unified addon system              
      3                                                                  
      4  import { beforeAll, describe, expect, test } from 'bun:test';   
      5  import Handlebars from 'handlebars';                            
     ...
       71    });                                                         
       72                                                                
       73    describe('has', () => {                                     
       74 -    test('checks module existence', () => {                   
       74 +    test('checks module (per-app addon) existence', () => {   
       75        const template = Handlebars.compile('{{#if (has         
           "module" "shadcn")}}yes{{else}}no{{/if}}');                   
       76 -      expect(template({ modules                               
          -: ['shadcn', 'mdx'] })).toBe('yes');                          
       77 -      expect(template({ modules: ['mdx'] })).toBe('no');      
       78 -      expect(template({ modules: [] })).toBe('no');           
       76 +      expect(template({ addons                                
          +: ['shadcn', 'mdx'] })).toBe('yes');                          
       77 +      expect(template({ addons: ['mdx'] })).toBe('no');       
       78 +      expect(template({ addons: [] })).toBe('no');            
       79      });                                                       
       80                                                                
       81 -    test('checks database value', () => {                     
       81 +    test('checks database (global addon) value', () => {      
       82        const template = Handlebars.compile('{{#if (has         
           "database" "postgres")}}yes{{else}}no{{/if}}');               
       83 -      expect(template({ database: 'postgres' })).toBe('yes'); 
       84 -      expect(template({ database: 'mysql' })).toBe('no');     
       85 -      expect(template({})).toBe('no');                        
       83 +      expect(template({ globalAddons: ['postgres']            
          + })).toBe('yes');                                             
       84 +      expect(template({ globalAddons: ['mysql']               
          + })).toBe('no');                                              
       85 +      expect(template({ globalAddons: [] })).toBe('no');      
       86      });                                                       
       87                                                                
       88 -    test('checks orm value', () => {                          
       88 +    test('checks orm (global addon) value', () => {           
       89        const template = Handlebars.compile('{{#if (has "orm"   
           "drizzle")}}yes{{else}}no{{/if}}');                           
       90 -      expect(template({ orm: 'drizzle' })).toBe('yes');       
       91 -      expect(template({ orm: 'prisma' })).toBe('no');         
       90 +      expect(template({ globalAddons: ['drizzle']             
          + })).toBe('yes');                                             
       91 +      expect(template({ globalAddons: ['prisma']              
          + })).toBe('no');                                              
       92      });                                                       
       93                                                                
       94 -    test('checks extra existence', () => {                    
       94 +    test('checks extra (global addon) existence', () => {     
       95        const template = Handlebars.compile('{{#if (has "extra" 
            "biome")}}yes{{else}}no{{/if}}');                            
       96 -      expect(template({ extras                                
          -: ['biome', 'husky'] })).toBe('yes');                         
       97 -      expect(template({ extras: ['husky'] })).toBe('no');     
       96 +      expect(template({ globalAddons                          
          +: ['biome', 'husky'] })).toBe('yes');                         
       97 +      expect(template({ globalAddons                          
          +: ['husky'] })).toBe('no');                                   
       98      });                                                       
       99                                                                
      100 +    test('checks addon (any addon) existence', () => {        
      101 +      const template = Handlebars.compile('{{#if (has "addon" 
          + "shadcn")}}yes{{else}}no{{/if}}');                           
      102 +      expect(template({ addons: ['shadcn'] })).toBe('yes');   
      103 +      expect(template({ globalAddons: ['shadcn']              
          +})).toBe('yes');                                              
      104 +      expect(template({ addons: [], globalAddons: []          
          +})).toBe('no');                                               
      105 +    });                                                       
      106 +                                                              
      107      test('checks stack existence in apps', () => {            
      108        const template = Handlebars.compile('{{#if (has "stack" 
            "nextjs")}}yes{{else}}no{{/if}}');                           
      109        expect(template({ apps: [{ stackName: 'nextjs' }, {     
           stackName: 'hono' }] })).toBe('yes');                         
     ...
      109      });                                                       
      110    });                                                         
      111                                                                
      112 +  describe('hasAddon', () => {                                
      113 +    test('returns true for per-app addon', () => {            
      114 +      const template = Handlebars.compile('{{#if (hasAddon    
          +"shadcn")}}yes{{else}}no{{/if}}');                            
      115 +      expect(template({ addons: ['shadcn'] })).toBe('yes');   
      116 +    });                                                       
      117 +                                                              
      118 +    test('returns true for global addon', () => {             
      119 +      const template = Handlebars.compile('{{#if (hasAddon    
          +"drizzle")}}yes{{else}}no{{/if}}');                           
      120 +      expect(template({ globalAddons: ['drizzle']             
          +})).toBe('yes');                                              
      121 +    });                                                       
      122 +                                                              
      123 +    test('returns false when addon not present', () => {      
      124 +      const template = Handlebars.compile('{{#if (hasAddon    
          +"prisma")}}yes{{else}}no{{/if}}');                            
      125 +      expect(template({ addons: [], globalAddons: []          
          +})).toBe('no');                                               
      126 +    });                                                       
      127 +  });                                                         
      128 +                                                              
      129    describe('hasContext', () => {                              
      130      test('returns true when context has key with value', ()   
           => {                                                          
      131 -      const template = Handlebars.compile('{{#if (hasContext "
          -orm")}}yes{{else}}no{{/if}}');                                
      132 -      expect(template({ orm: 'drizzle' })).toBe('yes');       
      131 +      const template = Handlebars.compile('{{#if (hasContext "
          +globalAddons")}}yes{{else}}no{{/if}}');                       
      132 +      expect(template({ globalAddons: ['drizzle']             
          + })).toBe('yes');                                             
      133      });                                                       
      134                                                                
      135      test('returns false when context key is undefined', () => 
            {                                                            
      136 -      const template = Handlebars.compile('{{#if (hasContext "
          -orm")}}yes{{else}}no{{/if}}');                                
      136 +      const template = Handlebars.compile('{{#if (hasContext "
          +globalAddons")}}yes{{else}}no{{/if}}');                       
      137        expect(template({})).toBe('no');                        
      138      });                                                       
      139    });                                                         
     ...
      141    describe('databaseUrl', () => {                             
      142      test('returns postgres URL', () => {                      
      143        const template = Handlebars.compile('{{databaseUrl}}'); 
      144 -      expect(template({ database: 'postgres'                  
          -, projectName: 'test' })).toBe(                               
      144 +      expect(template({ globalAddons: ['postgres']            
          +, projectName: 'test' })).toBe(                               
      145          'postgresql://postgres:password@localhost:5432/postgr 
           es-test',                                                     
      146        );                                                      
      147      });                                                       
      148                                                                
      149      test('returns mysql URL', () => {                         
      150        const template = Handlebars.compile('{{databaseUrl}}'); 
      151 -      expect(template({ database: 'mysql'                     
          -, projectName: 'test' })).toBe(                               
      151 +      expect(template({ globalAddons: ['mysql']               
          +, projectName: 'test' })).toBe(                               
      152          'mysql://mysql:password@localhost:3306/mysql-test',   
      153        );                                                      
      154      });                                                       
      155                                                                
      156      test('returns null for no database', () => {              
      157        const template = Handlebars.compile('{{databaseUrl}}'); 
      158 -      expect(template({ projectName: 'test' })).toBe('');     
      158 +      expect(template({ globalAddons: [],                     
          +projectName: 'test' })).toBe('');                             
      159      });                                                       
      160    });                                                         
      161  });                                                           

ÔùÅ Bash(bun test 2>&1 | tail -20)
  ÔÄ┐       at <anonymous> (/home/ttecim/.lab/create-faster/apps/cli/tests/cl
    i-integration.test.ts:174:31)
    (fail) CLI Integration > Turborepo generation > generates turborepo wit
    ÔÇª +20 lines (ctrl+o to expand)



ÔùÅ There's an old test file that needs to be removed (meta-validation.test.ts)
  and cli-integration.test.ts needs to be updated. Let me commit the current
  changes first, then continue with the remaining tasks:

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster && git add apps/cli/src/cli.ts
      apps/cli/src/prompts/stack-prompts.ts apps/cli/src/prompts/base-prompts.ts
       apps/cli/src/tui/suÔÇª)
  ÔÄ┐ [refactor/template-system 0372e95] refactor(cli): update prompts for un
    ified addon system
     6 files changed, 302 insertions(+), 272 deletions(-)
    ÔÇª +11 lines (ctrl+o to expand)


ÔùÅ Phase 5 complete. Now Task 10 - Phase 6: Template Migration. This involves
  moving templates from modules/, orm/, database/, extras/ to addons/. Let me
  check the current template structure:

ÔùÅ Searched for 1 pattern, read 1 file (ctrl+o to expand)

ÔùÅ Let me create a migration script to restructure the templates:

ÔùÅ Bash(cd /home/ttecim/.lab/create-faster/apps/cli/templates && mkdir -p addons)
  ÔÄ┐ ┬á(No content)

ÔùÅ Bash(for dir in modules/nextjs/*; do name=$(basename "$dir"); if [ -d "$dir"
      ]; then cp -r "$dir" "addons/$name"; fi; done)
  ÔÄ┐ ┬á(No content)

ÔùÅ Bash(ls modules/expo/ 2>/dev/null && for dir in modules/expo/*; do
      name=$(basename "$dir"); if [ -d "$dir" ]; then cp -r "$dir"
      "addons/$name"; fi; done)
  ÔÄ┐ ┬ánativewind

ÔùÅ Bash(ls modules/hono/ 2>/dev/null && for dir in modules/hono/*; do
      name=$(basename "$dir"); if [ -d "$dir" ]; then cp -r "$dir"
      "addons/$name"; fi; done)
  ÔÄ┐ ┬áError: Exit code 2

ÔùÅ Read 1 file (ctrl+o to expand)
  ÔÄ┐ ┬áContext limit reached ┬À /compact or /clear to continue

Ô£╗ Cogitated for 11m 50s

ÔØ» /compact 
  ÔÄ┐  Error: Error during compaction: Error: Conversation too long. Press esc
     twice to go up a few messages and try again.